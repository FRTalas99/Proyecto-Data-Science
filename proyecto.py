# -*- coding: utf-8 -*-
"""PROYECTO.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1OeEeU0hE54Du8Buj-VTyEE4Kr53q8RIs

---

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 15px;">
    <h1 style="font-size: 40px; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">PROYECTO DS üìö üíª üìä üß™</h1>
    <p style="font-size: 32px; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Camino hacia la transici√≥n energ√©tica - Una perspectiva desde el mercado el√©ctrico</p>
    <h1 style="font-size: 30px; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Segunda Entrega del Proyecto Final - Obtenci√≥n de Insights a partir de visualizaciones -</h1>

  <p style="text-align: center;">
  <img src="https://www.esig.energy/wp-content/uploads/2023/02/Capacity-report-landing-page-photo-scaled.jpg" alt="Imagen">
    </p>
    <h1 style="font-size: 18px; text-align: left; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Comunidad Coderhouse</h1>
    </p>
    <h1 style="font-size: 18px; text-align: left; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Curso Data Science</h1>
    </p>
    <h1 style="font-size: 18px; text-align: left; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Plantel docente: Prof. Ruiz, Jorge & Tutora Ruscitti, Aldana</h1>
    </p>
    <h1 style="font-size: 18px; text-align: left; font-weight: bold; font-family: 'Lexend', sans-serif; color: black;">Alumno: Risculese Francisco</h1>
  </div>
</div>

---

---

### Abstracto
<section id="1">

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 10px;">
    <h1 style="font-family: 'Lexend', sans-serif; color: black; font-size: 60px">üìú Abstracto</h1>
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      La estimaci√≥n del precio de la energ√≠a el√©ctrica es un desaf√≠o crucial en el contexto de la sostenibilidad y la transici√≥n energ√©tica, temas de gran relevancia en la actualidad. Para abordar este desaf√≠o, es fundamental comprender en detalle el comportamiento de la variable a estimar, identificar a los actores clave en el mercado energ√©tico y analizar las complejidades que influyen en este sector.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      El incremento en los precios de los combustibles f√≥siles, as√≠ como su dependencia en muchos pa√≠ses, ha resultado en un aumento significativo en el precio de la energ√≠a el√©ctrica. Sin embargo, esta situaci√≥n ha impulsado el inter√©s en soluciones energ√©ticas renovables a corto plazo. En Espa√±a, el gobierno est√° acelerando la aprobaci√≥n de proyectos que se centran en la sostenibilidad y la protecci√≥n del medio ambiente. Esto incluye la adopci√≥n de tecnolog√≠as avanzadas y promueve aspectos positivos como la autogesti√≥n y el autoconsumo de energ√≠a.
    </p>
  </div>
</div>

---

---

### Objetivo
<section id="2">

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 10px;">
    <h1 style="font-family: 'Lexend', sans-serif; color: black; font-size: 60px">üéØ Objetivo</h1>
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Predicci√≥n del precio de la energ√≠a el√©ctrica en Espa√±a, mediante modelos de regresi√≥n, para el per√≠odo 2015-2018 empleando un dataset obtenido del website "Kaggle".
    </p>
  </div>
</div>

---

---

### Contexto comercial
<section id="3">

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 10px;">
    <h1 style="font-family: 'Lexend', sans-serif; color: black; font-size: 60px">üè≠ Contexto comercial</h1>
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Se debe conocer de antemano que el aumento de los precios de los combustibles f√≥siles, como el gas natural y el carb√≥n, ha provocado un aumento de los precios de la energ√≠a el√©ctrica. Este aumento es especialmente notable en los pa√≠ses que dependen en gran medida de los combustibles f√≥siles para generar electricidad.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Las energ√≠as renovables (hidroel√©ctricas, solar o e√≥lica) son una fuente de energ√≠a m√°s barata y fiable que los combustibles f√≥siles.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Adem√°s, su aplicaci√≥n y campo de acci√≥n ha ocupado un buen espacio en el sector de la energ√≠a para electrificaci√≥n, seg√∫n datos de consumo medidos en el a√±o 2019.

![img](https://www.ren21.net/wp-content/uploads/2022/06/GSR2022_Figure_5.png)
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      En materia de costos, las energ√≠as solar y e√≥lica han disminuido significativamente su valor en los √∫ltimos a√±os, lo que las ha hecho m√°s competitivas con respecto a las fuentes de energ√≠a convencionales (combustibles f√≥siles). El aumento de la participaci√≥n de estas energ√≠as limpias en la matriz energ√©tica apoya a la reducci√≥n de los precios de la energ√≠a el√©ctrica.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      La determinaci√≥n del precio sigue una secuencia de actividades que involucra a todos los actores de la cadena de negocio (explicado a continuaci√≥n), pero para entenderlo desde una perspectiva clara desde el precio: se debe conocer que aquellas energ√≠as poco flexibles que ofertan su producci√≥n a costos bajos (solar y e√≥lica) o aquellas que ofertan su producci√≥n de forma constante y a plena potencia, como la nuclear, podr√°n disminuir con sus ofertas el precio de este servicio. Esto se justifica porque las tecnolog√≠as mencionadas ofertan de manera necesaria toda la energ√≠a que producen, ya que no poseen la capacidad de almacenar y gestionar sus recursos (son, como se dijo, poco flexibles).
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Por otro lado, aquellas que ofertan su generaci√≥n con costos de producci√≥n elevados (las que emplean combustibles f√≥siles), hacen que el precio suba, y pueden participar con mucha m√°s flexibilidad frente a los requerimientos de la demanda. Un comportamiento similar ocurre con las centrales hidroel√©ctricas que pueden gestionar de forma pr√°ctica el recurso h√≠drico, pero con la diferencia que poseen un costo de obtenci√≥n del recurso nulo, al ser obtenido del medio ambiente.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      En Espa√±a, el precio de la electricidad se ha multiplicado por cuatro en los √∫ltimos a√±os. Este aumento es debido a la creciente dependencia de los combustibles f√≥siles para generar electricidad. Por ello, el gobierno espa√±ol est√° acelerando la transici√≥n a las energ√≠as renovables. Fuentes gubernamentales proponen aumentar la participaci√≥n de las energ√≠as renovables en la matriz energ√©tica espa√±ola del 40% al 74% para 2030.
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Como Espa√±a, muchos pa√≠ses se involucran en este movimiento acelerado y los cambios en un plazo de 10 a√±os, a nivel mundial, est√°n tomando cada vez m√°s impronta, sobre todo en el sector de la electrificaci√≥n.

![img](https://www.ren21.net/wp-content/uploads/2022/06/GSR2022_Figure_11.png)
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
</div>
</details>

---

---

### Problema comercial
<section id="4">  

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 10px;">
    <h1 style="font-family: 'Lexend', sans-serif; font-size: 60px ; color: black;">üí≠ Problema comercial</h1>
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Como cient√≠fico de datos, se desempe√±ar√° la labor en estimar el precio de la energ√≠a el√©ctrica para la empresa OMIE. Es obligatorio conocer el comportamiento del mercado el√©ctrico espa√±ol, y el de sus actores participantes. Siendo el OMIE el operador del Mercado Ib√©rico de Energ√≠a, que opera tanto en Portugal como en Espa√±a: este tiene diversas funciones en todo el proceso de intercambio de energ√≠a, regulando el proceso e interviniendo en ciertas circunstancias, por ejemplo en acuerdos entre los comercializadores (compradores de energ√≠a) y los generadores (vendedores de energ√≠a).
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      En forma resumida, participa como un actor terminal el sector de los generadores, que son los destinados a producir la energ√≠a el√©ctrica, sea generada por fuentes convencionales de energ√≠a (como la nuclear o los combustibles f√≥siles) o por fuentes renovables (destac√°ndose la hidroel√©ctrica y la e√≥lica).
    <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
      Luego, la matriz de transportistas, distribuidores y comercializadores, por separado, brindar√°n las condiciones necesarias para que el servicio sea trasladado, por medio de las redes de alta-media-baja tensi√≥n, al otro actor terminal que forma parte del negocio: el sector consumidor.

![img](https://alcanzia.es/static/img/bg_mercadoelectrico.png)

    
  <p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px">
    A partir de ciertas evaluaciones, se buscar√° hacer uso del mejor modelo que se adapte a cumplir con el objetivo y afrontar el problema comercial, guiado por una serie de interrogantes e hip√≥tesis planteadas, las cuales se desarrollar√°n en el EDA (Exploratory Data Analysis).

<p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px; text-align: center;">
Preguntas principales

  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Variable precio. ¬øQu√© resultados se observan, haciendo un an√°lisis estad√≠stico descriptivo e inferencial, sobre la variable target?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Evoluci√≥n temporal para el precio. ¬øC√≥mo se comporta el precio de la energ√≠a el√©ctrica a lo largo del per√≠odo considerado? ¬øC√≥mo se lleva a cabo la descomposici√≥n de la serie temporal, y qu√© se puede determinar realizando √©sto? ¬øQu√© sucede con la estacionalidad de la serie temporal?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Generaci√≥n energ√©tica y precio de la electricidad. ¬øC√≥mo se da la evoluci√≥n en el aporte de cada fuente de generaci√≥n energ√©tica en un per√≠odo anual? ¬øY c√≥mo se da la evoluci√≥n en el aporte de cada fuente de generaci√≥n energ√©tica en un per√≠odo diario? ¬øQu√© relaci√≥n se puede obtener si se incluye la variable precio a estas visualizaciones?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Valores at√≠picos de la variable precio. ¬øQu√© an√°lisis se puede realizar teniendo en cuenta los valores outliers?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Generaci√≥n de energ√≠a por ubicaci√≥n geogr√°fica. Si el conjunto de datos incluye informaci√≥n sobre la ubicaci√≥n de las plantas de generaci√≥n de energ√≠a, ¬øc√≥mo var√≠a la generaci√≥n de energ√≠a en diferentes regiones geogr√°ficas? ¬øQu√© se obtiene de un an√°lisis multivariado?

<p style="font-family: 'Lexend', sans-serif; color: black; font-size: 20px; text-align: center;">
Preguntas complementarias

  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Evoluci√≥n de la demanda de energ√≠a en el pa√≠s. ¬øC√≥mo evoluciona la situaci√≥n de esta variable para los a√±os de estudio? ¬øQu√© comportamientos se muestran con respecto a su tendencia? ¬øQu√© se puede concluir respecto a un per√≠odo semanal de consumo?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Evoluci√≥n temporal para el precio. ¬øC√≥mo se comporta el precio de la energ√≠a el√©ctrica analizando cada a√±o en particular?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° ¬øQu√© relaci√≥n se puede establecer, a grandes rasgos, entre la variable demanda y el precio fijado de la energ√≠a el√©ctrica?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Relaciones con la variable precio. ¬øQu√© relaci√≥n se puede establecer, a grandes rasgos, entre la variable target y las dem√°s features?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Generaci√≥n energ√©tica. ¬øQu√© se puede observar cuando se analiza la distribuci√≥n de valores en un histograma para cada variable?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Valores at√≠picos de la variable precio. ¬øQu√© comportamiento presenta la variable target, analizando sus valores at√≠picos?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Valores at√≠picos de las variables climatol√≥gicas. ¬øQu√© comportamientos presentan las variables, analizando sus valores at√≠picos? ¬øQu√© toma de decisi√≥n se puede realizar con el an√°lisis?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Generaci√≥n energ√©tica. ¬øCu√°l es el aporte absoluto de cada fuente de energ√≠a (renovable o convencional) a su generaci√≥n total? ¬øQu√© comportamiento exhibe cada fuente?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Proporci√≥n en la generaci√≥n. ¬øCu√°l es la proporci√≥n porcentual de generaci√≥n de energ√≠a proveniente tanto de fuentes renovables como de fuentes convencionales?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Impacto ambiental. ¬øExiste alguna correlaci√≥n entre la generaci√≥n de energ√≠a a partir de fuentes f√≥siles y las emisiones de gases de efecto invernadero u otros impactos ambientales?
  <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
‚ö° Potencia instalada en el sector de generaci√≥n energ√©tica. ¬øC√≥mo se distribuye la cantidad de potencia instalada para las diversas tecnolog√≠as de producci√≥n de energ√≠a el√©ctrica?
  </div>
</details>

---

---

### Contexto anal√≠tico
<section id="5">

  <div style="width: 100%; text-align: center;">
    <div style="max-width: 800px; margin: 0 auto; border: 4px solid #ed8a3f; background-color: #d4e8c1; padding: 10px;">
      <h1 style="font-family: 'Lexend', sans-serif; color: black;">üë®‚Äçüíª Contexto anal√≠tico</h1>
      <p style="font-family: 'Lexend', sans-serif; color: black;">
        Se cuentan con dos datasets, bajo un nombre gen√©rico que identifica a ambos. Estos est√°n en formato .csv.
      </p>
      <p style="font-family: 'Lexend', sans-serif; color: black;">
        Uno se utiliz√≥ para desarrollar los primeros 6 desaf√≠os entregables y el restante contiene informaci√≥n adicional y complementaria que se utiliz√≥ para desarrollar los restantes 6 desaf√≠os entregables, que conten√≠an un complemento a la Data Acquisition mediante APIs p√∫blicas, Data Wrangling y Data Storytelling.
      </p>
      <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
        <strong>Dataset general: Hourly energy demand generation and weather.</strong> El dataset general contiene, en un per√≠odo de 4 a√±os, datos sobre el consumo, generaci√≥n, precio y climatolog√≠a en Espa√±a.
      </p>
      <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
        <strong><a href="https://www.kaggle.com/datasets/nicholasjhana/energy-consumption-generation-prices-and-weather?select=energy_dataset.csv" target="_blank">energy_dataset.csv</a></strong>: Contiene datos sobre consumo y generaci√≥n, recopilados desde el portal p√∫blico del ENTSOE-E (European Network of Transmission System Operators) para los operadores de red de transporte TSO (Transmission Service Operator). La declaraci√≥n de los precios fue obtenida por el TSO de Espa√±a: Red El√©ctrica Espa√±a.
      </p>
      <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
        <strong><a href="https://www.kaggle.com/datasets/nicholasjhana/energy-consumption-generation-prices-and-weather?select=weather_features.csv" target="_blank">weather_features.csv</a></strong>: La informaci√≥n climatol√≥gica fue comprada como parte de un proyecto personal, desde el <a href="https://openweathermap.org/api" target="_blank">Open Weather API</a>, para las 5 ciudades m√°s grandes del pa√≠s, y empleadas para este proyecto (Madrid, Barcelona, Valencia, Sevilla y Bilbao).
      </p>
      <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
        Tambi√©n se emplea informaci√≥n adicional:
      </p>
      <ul style="color: black; text-align: left;">
        <li><a href="https://transparency.entsoe.eu/dashboard/show" target="_blank">Portal p√∫blico del ENTSOE-E (European Network of Transmission System Operators)</a></li>
        <li><a href="https://www.omie.es/es/market-results/daily/daily-market/hourly-power-technologies" target="_blank">Website del OMIE (ente regulador del precio)</a></li>
        <li><a href="https://demanda.ree.es/visiona/seleccionar-sistema" target="_blank">Website de la REE (Red El√©ctrica de Espa√±a) - ente del transporte energ√©tico -</a></li>
        <li><a href="https://centrodedescargas.cnig.es/CentroDescargas/busquedaRedirigida.do?ruta=PUBLICACION_CNIG_DATOS_VARIOS/aneTematico/Espana_Principales-centrales-electricas_2014-2016_mapa_15048_spa.zip"> Centro de descargas del CNIG</a></li>
        <li><a href="https://www.sistemaelectrico-ree.es/">Informes anuales de la REE</a></li>
        <li><a href="https://drive.google.com/drive/folders/1OHJ3Zt4fFWxlzVgdGE1oD7PcfASJOYl6?usp=sharing" target="_blank">Bibliograf√≠a consultada</a></li>
        <li><a href="https://es.wikipedia.org/wiki/Valor_at%C3%ADpico" target="_blank">Valor at√≠pico - Wikipedia</a></li>
      </ul>
      <p style="font-family: 'Lexend', sans-serif; color: black; text-align: left;">
        Se puede realizar un breve an√°lisis descriptivo de las variables que contienen ambos datasets, detallando sus unidades de medida y colocando una breve descripci√≥n con respecto al recurso energ√©tico que figura. Todas las medidas son para el pa√≠s de Espa√±a, a nivel nacional.
      </p>
      <h2 style="color: black;">Primer dataset</h2>
      <ul style="color: black; text-align: left;">
        <li>'time': Es el tiempo medido desde el 31 de diciembre del 2014 hasta el 31 de diciembre del 2018, en escala diaria y en intervalos de 1 hora. Siguiendo el est√°ndar del <a href="https://es.wikipedia.org/wiki/Hora_central_europea" target="_blank">CET (Central European Time)</a>.</li>
        <li>'generation biomass': Es la generaci√≥n el√©ctrica a partir del recurso renovable <a href="https://es.wikipedia.org/wiki/Biomasa_(energ%C3%ADa)" target="_blank">biomasa</a> - Unidades en MW -</li>
        <li>'generation fossil brown coal/lignite': Es la generaci√≥n el√©ctrica a partir del combustible f√≥sil <a href="https://es.wikipedia.org/wiki/Lignito" target="_blank">Lignito/carb√≥n marr√≥n</a> - Unidades en MW -</li>
        <li>'generation fossil coal-derived gas': Es la generaci√≥n el√©ctrica a partir del combustible f√≥sil <a href="https://es.wikipedia.org/wiki/Gas_de_alumbrado" target="_blank">gas de carb√≥n</a> - Unidades en MW -</li>
        <li>'generation fossil gas': Es la generaci√≥n el√©ctrica a partir del <a href="https://es.wikipedia.org/wiki/Gas_natural" target="_blank">gas f√≥sil natural</a> - Unidades en MW -</li>
        <li>'generation fossil hard coal': Es la generaci√≥n el√©ctrica a partir del <a href=https://es.wikipedia.org/wiki/Antracita target="_blank">carb√≥n f√≥sil duro o Antracita</a> - Unidades en MW -</li>
        <li>'generation fossil oil': Es la generaci√≥n el√©ctrica a partir de <a href=https://es.wikipedia.org/wiki/Fueloil target="_blank">fueloil</a> - Unidades en MW -</li>
        <li>'generation fossil oil shale': Es la generaci√≥n el√©ctrica a partir de <a href=https://es.wikipedia.org/wiki/Esquistos_bituminosos target="_blank">Esquistos bituminosos f√≥siles (Oil shale)</a> - Unidades en MW -</li>
        <li>'generation fossil peat': Es la generaci√≥n el√©ctrica a partir del material f√≥sil <a href=https://es.wikipedia.org/wiki/Turba target="_blank">Turba</a> - Unidades en MW -</li>
        <li>'generation geothermal': Es la generaci√≥n el√©ctrica renovable a partir de la <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_geot%C3%A9rmica target="_blank">energ√≠a geot√©rmica</a> - Unidades en MW -</li>
        <li>'generation hydro pumped storage aggregated': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://www.worldenergytrade.com/energias-alternativas/agua-y-vapor/que-es-la-energia-hidroelectrica-por-bombeo target="_blank">recurso h√≠drico, considerando un almacenamiento mediante un sistema de bombeo a√±adido</a> - Unidades en MW -</li>
        <li>'generation hydro pumped storage consumption': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://www.worldenergytrade.com/energias-alternativas/agua-y-vapor/que-es-la-energia-hidroelectrica-por-bombeo target="_blank">recurso h√≠drico, considerando un almacenamiento mediante un sistema de bombeo a√±adido</a> - Unidades en MW -</li>
        <li>'generation hydro run-of-river and poundage': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://es.wikipedia.org/wiki/Central_hidroel%C3%A9ctrica_de_pasada target="_blank">recurso h√≠drico, considerando una central hidroel√©ctrica fluyente/de pasada</a> - Unidades en MW -</li>
        <li>'generation hydro water reservoir': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://es.wikipedia.org/wiki/Embalse target="_blank">recurso h√≠drico, considerando un reservorio/embalse</a> - Unidades en MW -</li>
        <li>'generation marine': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_marina target="_blank">recurso del mar</a> - Unidades en MW -</li>
        <li>'generation nuclear': Es la generaci√≥n el√©ctrica a partir de la <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_nuclear target="_blank">energ√≠a nuclear</a> - Unidades en MW -</li>
        <li>'generation other': Es la generaci√≥n el√©ctrica considerando otras fuentes energ√©ticas, no consideradas en este listado de variables - Unidades en MW -</li>
        <li>'generation other renewable': Es la generaci√≥n el√©ctrica renovable considerando otras fuentes energ√©ticas, no consideradas en este listado de variables - Unidades en MW -</li>
        <li>'generation solar': Es la generaci√≥n el√©ctrica renovable empleando la <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_solar target="_blank">energ√≠a solar</a> - Unidades en MW -</li>
        <li>'generation waste': Es la generaci√≥n el√©ctrica a partir del aprovechamiento energ√©tico de los <a href=https://es.wikipedia.org/wiki/Aprovechamiento_energ%C3%A9tico_de_residuos target="_blank">residuos</a> - Unidades en MW -</li>
        <li>'generation wind offshore': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_e%C3%B3lica_marina target="_blank">recurso e√≥lico marino, u "offshore"</a> - Unidades en MW -</li>
        <li>'generation wind onshore': Es la generaci√≥n el√©ctrica renovable a partir del <a href=https://es.wikipedia.org/wiki/Energ%C3%ADa_e%C3%B3lica target="_blank">recurso e√≥lico terrestre, u "onshore"</a> - Unidades en MW -</li>
        <li>'forecast solar day ahead': Es la previsi√≥n del d√≠a siguiente al considerado, sobre la generaci√≥n el√©ctrica renovable empleando la energ√≠a solar - Unidades en MW
        <li>'forecast wind offshore eday ahead': Es la previsi√≥n del d√≠a siguiente al considerado, sobre la generaci√≥n el√©ctrica renovable a partir del recurso e√≥lico marino, u "offshore" - Unidades en MW
        <li>'forecast wind onshore day ahead': Es la previsi√≥n del d√≠a siguiente al considerado, sobre la generaci√≥n el√©ctrica renovable a partir del recurso e√≥lico terrestre, u "onshore" - Unidades en MW
        <li>'total load forecast': Es la previsi√≥n del d√≠a siguiente al considerado, sobre la demanda el√©ctrica que tiene el pa√≠s - Unidades en MW
        <li>'total load actual': Es la demanda el√©ctrica que tiene el pa√≠s - Unidades en MW
        <li>'price day ahead': Es la previsi√≥n del d√≠a siguiente al considerado, sobre el precio de la energ√≠a el√©ctrica que tiene el pa√≠s - Unidades en ‚Ç¨/MWh
        <li>'price actual': Es el precio de la energ√≠a el√©ctrica que tiene el pa√≠s - Unidades en ‚Ç¨/MWh
      </ul>
      <h2 style="color: black;">Segundo dataset - Data Enrichment -</h2>
      <ul style="color: black; text-align: left;">
        <li>'dt_iso': Es el tiempo medido desde el 31 de diciembre del 2014 hasta el 31 de diciembre del 2018, en escala diaria y en intervalos de 1 hora. Siguiendo el est√°ndar del CET (Central European Time).</li>
        <li>'city_name': Alude al nombre de la ciudad para la cual se obtienen los datos de cada variable (incluyen las ciudades de Madrid, Barcelona, Sevilla, Valencia y Bilbao).</li>
        <li>'temp': Valores medidos de temperatura, en grados Kelvin (¬∫K).</li>
        <li>'temp_min': Valores medidos para los m√≠nimos de temperatura, para dicho momento temporal, en grados Kelvin (¬∫K).
        <li>'temp_max': Valores medidos para los m√°ximos de temperatura, para dicho momento temporal, en grados Kelvin (¬∫K).
        <li>'pressure': Valores medidos para la presi√≥n atmosf√©rica (a nivel del mar), en HPa - 1 HPa = 0,00099 atm = 0.0145 psi
        <li>'humidity': Valores medidos para la humedad, en porcentajes.
        <li>'wind_speed': Valores medidos para la velocidad del viento, en m/s.
        <li>'wind_deg': Valores medidos para la direcci√≥n del viento, en grados (meteorol√≥gicos).
        <li>'rain_1h': Volumen de lluvia para la √∫ltima hora considerada, en mm.
        <li>'rain_3h': Volumen de lluvia para las √∫ltimas tres horas consideradas, en mm.
        <li>'snow_3h': Volumen de nieve para las √∫ltimas tres horas consideradas, en mm. y considerando el estado l√≠quido.
        <li>'clouds_all': Porcentaje de nubosidad.
        <li>'weather_id': ID referido a la condici√≥n clim√°tica.
        <li>'weather_main': Grupo categ√≥rico de par√°metros clim√°ticos (lluvia, nieve, evento extremo, etc.)
        <li>'weather_description': Condici√≥n clim√°tica dentro del grupo categ√≥rico.
        <li>'weather_icon': √çcono clim√°tico asociado al ID.
      </ul>   
      <p style="font-family: 'Lexend', sans-serif; color: black;">
        Se debe complementar la informaci√≥n brindada de las √∫ltimas 4 variables con el contenido del siguiente <a href=https://openweathermap.org/weather-conditions target="_blank">enlace</a>. Toda la informaci√≥n, como se aclar√≥ antes, proviene de <a href=https://openweathermap.org/history-bulk#list target="_blank">OpenWeather.</a>
      <p style="font-family: 'Lexend', sans-serif; color: black;">
      El siguiente <a href=https://docs.google.com/spreadsheets/d/1HJvQQjM-gGTbYf9eCyegBNbutm3htHRKweu1HQsPEmk/edit?usp=sharing="_blank">documento en formato .xlsx</a> hace una revisi√≥n de algunos par√°metros importantes, referidos a las 5 principales Comunidades Aut√≥nomas (CC.AA.) del pa√≠s ib√©rico. Se busca que a la hora de tratar y analizar los datos en esta notebook ya se cuente con una base de informaci√≥n estad√≠stica sobre par√°metros como poblaci√≥n, infraestructura, generaci√≥n el√©ctrica y consumo el√©ctrico.
    </div>
  </div>
</details>

---

---

### Importaci√≥n de librer√≠as
<section id="6">
  
  <div style="width: 100%; text-align: center;">
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 20px; border-radius: 10px;">
        <h1 style="border: 2px solid #f8f8f8; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; font-size: 50px; padding: 5px; border-radius: 10px;">
          üìö Importaci√≥n de Librer√≠as</h1>
      </div>
    </div>
  </div>
</section>

---

- Se importan las librerias correspondientes para efectuar los pasos del Proyecto de DS
"""

import pandas as pd
import numpy as np

import matplotlib as mpl
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
import matplotlib.dates as mdates
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
import plotly.io as pio
import bokeh.plotting as bkplt
import graphviz
from bokeh.plotting import figure, show
from bokeh.models import ColorBar, ColumnDataSource, HoverTool
from bokeh.transform import linear_cmap
from bokeh.io import output_notebook
from bokeh.palettes import Viridis256

import pickle

import statsmodels.api as sm
import scipy.stats as stats
import scipy.stats.mstats as mstats
from statsmodels.tsa.stattools import adfuller
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from sklearn.preprocessing import StandardScaler
from sklearn.feature_selection import f_classif
from sklearn.feature_selection import VarianceThreshold
from sklearn.feature_selection import f_regression, SelectKBest
from sklearn.metrics import mean_squared_error as mse
from sklearn.pipeline import Pipeline
from scipy.stats import pearsonr
from scipy.stats import shapiro
from sklearn.preprocessing import PolynomialFeatures
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error
from sklearn.neighbors import KNeighborsRegressor
from sklearn.tree import DecisionTreeRegressor
from sklearn.tree import plot_tree
from sklearn import tree

import warnings
warnings.filterwarnings("ignore", category=UserWarning)

"""---

### Data Acquisition
<section id="7">

  <div style="width: 100%; text-align: center;">
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 20px; border-radius: 10px;">
        <h1 style="border: 2px solid #f8f8f8; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; font-size: 50px; border-radius: 10px;">
          üì• Data Acquisition
        </h1>
</section>

---

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 5px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 25px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
      1¬∞ Dataset - Google Drive a Google Colab

- Obtenci√≥n de la data para el primer dataset
    - Se monta el sistema de archivos de Google Drive
    - Se sigue la ruta de los archivos .csv
    -Se leen los archivos .csv uno por uno, en un DataFrame (df) de Pandas
"""

# Commented out IPython magic to ensure Python compatibility.
from google.colab import drive
import os
drive.mount ('/content/gdrive')

# 1¬∞ dataset - Hourly energy demand generation and weather
# %cd '/content/gdrive/MyDrive'

# 1¬∞ dataset (energy_dataset.csv)
df_energy = pd.read_csv('Portfolio DS&A/Proyecto final - Data Science/PROYECTO DS - Risculese Francisco/1¬∞ Entrega - PROYECTO FINAL DS/DesafiÃÅo entregable N¬∫1 - PROYECTO DS/Caso energeÃÅtico_EspanÃÉa/energy_dataset.csv',sep=',')

df_energy

"""---

### Data Wrangling
<section id="8">

<div style="width: 100%; text-align: center;">
  <div style="max-width: 600px; margin: 0 auto;">
    <div style="background-color: #DEB887; padding: 20px; border-radius: 10px;">
      <h1 style="border: 2px solid #f8f8f8; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; font-size: 50px; padding: 5px; border-radius: 10px;">
        ‚öôÔ∏è Data Wrangling
      </h1>
    </div>
  </div>
</div>

---

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Descubrimiento de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Comprensi√≥n de los datos, su estructura, tipolog√≠a y cantidad. Tambi√©n lo es conocer por qu√© una compa√±√≠a los utiliza y c√≥mo. √âsto sirve para tomar decisiones posteriores con un rumbo claro".
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Tener en cuenta el contexto anal√≠tico para el primer dataset, sobre el origen de los datos, utilizaci√≥n en el negocio y tipos de datos empleados.
          </p>
          En una primera parte, antes del Data Enrichment, se trabajar√° con datos sobre generaci√≥n/producci√≥n, consumo y precio.
          </p>
          Luego del Data Enrichment, se trabajar√° con las variables clim√°ticas, teniendo en cuenta lo visto en el contexto anal√≠tico para la toma de decisiones en base al grado de relevancia que tenga cada ciudad espa√±ola en la matriz energ√©tica.
      </div>
</div>

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Estructuraci√≥n de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Estandarizar el formato de los datos, esto tiene dependencia directa en diversas fuentes u or√≠genes: as√≠ los datos estar√°n en diferentes formatos y estructuras".
      </div>
</div>

- Seteo de feature 'time' como index
"""

df_energy.index = df_energy['time']
df_energy = df_energy.drop('time', axis='columns')

df_energy

"""- Seteo del index como un tipo de dato "datetime"
- An√°logo a lo anterior: pero con los valores con respecto a tiempo universal coordinado o UTC
- Chequeo del index como un tipo de dato "datetime"
"""

df_energy.index = pd.to_datetime(df_energy.index, utc='True')

df_energy.index

"""- Empleo del comando tz_localize para remoci√≥n del uso horario o time zone, manteniendo el resto de los valores temporales
- Remoci√≥n del valor temporal de 2014 (ya que no aporta a la data)
"""

df_energy = df_energy.tz_localize(None)

df_energy = df_energy[df_energy.index.year >=2015]

df_energy.index

"""- Exploraci√≥n de las columnas del primer dataset"""

df_energy.columns

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Limpieza de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Eliminaci√≥n de los datos que no brinden informaci√≥n extra como los duplicados, datos faltantes, etc. Este paso lograr√° estandarizar el formato de las columnas (float, datatimes, etc)."

- Utilizaci√≥n del ".describe" para tener un breve pantallazo en materia estad√≠stica de las features
"""

pd.set_option('display.max_columns', None)
df_energy.describe().round(1)

"""- Eliminaci√≥n de features"""

df_energy = df_energy.drop(['generation fossil coal-derived gas','generation fossil oil shale',
                            'generation fossil peat', 'generation geothermal',
                            'generation hydro pumped storage aggregated', 'generation marine',
                            'generation wind offshore', 'forecast wind offshore eday ahead',
                            'total load forecast', 'forecast solar day ahead',
                            'forecast wind onshore day ahead', 'price day ahead'],
                            axis=1)

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          La eliminaci√≥n de las features anteriores se debe a que no pueden tener valores de generaci√≥n nulos a lo largo de todo su comportamiento.
          </p>
          Adem√°s, existen features totalmente ocupadas por valores NaN.

- Chequeo por la dimensi√≥n del dataframe
"""

df_energy.shape

"""- Recuento de datos temporales para cada a√±o"""

df_energy_2015 = df_energy[df_energy.index.year == 2015]
df_energy_2016 = df_energy[df_energy.index.year == 2016]
df_energy_2017 = df_energy[df_energy.index.year == 2017]
df_energy_2018 = df_energy[df_energy.index.year == 2018]

count_2015 = df_energy_2015.shape[0]
count_2016 = df_energy_2016.shape[0]
count_2017 = df_energy_2017.shape[0]
count_2018 = df_energy_2018.shape[0]

conteo = pd.DataFrame({'A√±o': [2015, 2016, 2017, 2018], 'N√∫mero de filas': [df_energy_2015.shape[0], df_energy_2016.shape[0], df_energy_2017.shape[0], df_energy_2018.shape[0]]})

conteo

"""- Chequeo por los duplicados en el index"""

df_energy.index.has_duplicates

"""- Chequeo de valores nulos en cada una de las features restantes"""

df_energy.isna().sum()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Se puede observar que la mayor√≠a de los datos nulos pertenecen a la variable de demanda.
          </p>
          Afortunadamente, no se encuentran valores nulos en la columna perteneciente a la variable target.
          </p>
          Para aplicar un tratamiento simple, se tratar√°n a estos datos nulos con un m√©todo de interpolaci√≥n lineal. Seg√∫n el siguiente <a href="ttps://www.kaggle.com/code/dimitriosroussis/electricity-price-forecasting-with-dnns-eda" target="_blank"> proyecto</a> hecho en Kaggle, el m√©todo aplicado contraer√° un leve ruido al an√°lisis, pero no suficiente para alterar el rendimiento del trabajo en su totalidad.

- Visualizaci√≥n de los valores NaN en el dataframe
"""

df_energy[df_energy.isnull().any(axis=1)]

"""- Reemplazo de valores nulos -empleando el m√©todo de interpolaci√≥n lineal-"""

df_energy.interpolate(method='linear', limit_direction='forward', inplace=True, axis=0)

"""- Chequeo del reemplazo por el m√©todo citado anteriormente"""

dataframe_energy_nulos = pd.DataFrame({'Cantidad NaN' : df_energy.isnull().sum()})

dataframe_energy_nulos

"""- Chequeo final para datos faltantes/nulos -NaN-"""

df_energy.info()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Enriquecimiento de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Etapa referida a agregaci√≥n de datos extra (de fuentes externas) que complementen a los ya existentes, para agregar informaci√≥n extra al an√°lisis. En algunos casos se habla de la creaci√≥n de variables resumen, en forma adicional".

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 5px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 25px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
      2¬∞ Dataset - API p√∫blica de Kaggle a Google Colab

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Pasos a realizar:
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          1.  Ingresar a Kaggle, registrar un usuario y dirigirse al siguiente apartado <a href="https://www.kaggle.com/settings" target="_blank"> (configuraci√≥n)</a>
          </p>
          2.  Solicitar una API key en la secci√≥n de APIs.
          </p>
          3.  Al archivo descargado, en formato .json, ubicarlo en la carpeta de descargas, por defecto.
          </p>
          4.  Abrir el entorno de Google Colab, y seguir los dem√°s pasos (continuaci√≥n).

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          5.  Ejecutar el c√≥digo "!pip install kaggle" e importar kaggle con "import kaggle" al entorno.
"""

! pip install kaggle

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          6.  Subir el archivo que contiene la API key, en formato .json.
"""

from google.colab import files
files.upload()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          7.  Creaci√≥n de un nuevo directorio.

- √âste comando crea el directorio " ~/.kaggle" en caso de que no exista
    - Comando que se utiliza en entornos de terminal o shell
    - "mkdir" es un comando que crea directorios (carpetas)
    - "-p" es una opci√≥n que indica al comando que cree directorios intermedios si no existen -creaci√≥n autom√°tica de los directorios principales de ser necesario-
    - Para este caso: " ~/.kaggle" es la ruta del directorio que se desea crear
"""

!mkdir -p ~/.kaggle

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          8.  Movimiento del archivo que contiene la API key al directorio nuevo creado.

- Este comando utiliza "mv" -comando para mover o renombrar archivos o directorios-
    - "kaggle.json" es el nombre del archivo que se est√° moviendo y "~/.kaggle/" es la ubicaci√≥n de destino donde se desea mover el archivo
    - En este caso: se est√° moviendo el archivo kaggle.json al directorio "~/.kaggle/"
"""

!mv kaggle.json ~/.kaggle/

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          9.  Revisi√≥n de los pasos realizados, particularmente para hacer un chequeo de que el archivo .json se encuentre en el lugar deseado.

- Al ejecutar este comando, se visualiza una lista de los archivos y carpetas dentro del directorio "~/.kaggle"
    - El comando "ls" se utiliza para listar los contenidos de un directorio
    - "~/.kaggle" es el directorio que se desea listar
"""

!ls ~/.kaggle

"""- Al ejecutar este comando, se mostrar√° informaci√≥n sobre el archivo "kaggle.json" si existe en la ubicaci√≥n especificada
    - Similar al anterior, pero se aplica a un archivo espec√≠fico, en este caso, "kaggle.json"
"""

!ls ~/.kaggle/kaggle.json

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          10.  Enlistar los datasets de Kaggle

- Este comando permite hacer una b√∫squeda de datasets, filtrando por las palabras clave deseadas
"""

!kaggle datasets list -s 'energy'

"""- Se procede a seleccionar el dataset general que se emple√≥ en las primeras entregas: "Hourly energy demand generation and weather"

- Espec√≠ficamente, y a partir de ahora, se debe seleccionar un archivo .csv de los dos que contiene el dataset general (weather_features.csv).

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          11.  Descargar el dataset proveniente de Kaggle.
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Se procede a seleccionar el dataset general que se emple√≥ en las primeras entregas: "Hourly energy demand generation and weather".
        </p>
        Espec√≠ficamente, y a partir de ahora, se debe seleccionar un archivo .csv de los dos que contiene el dataset general: "weather_features.csv".

- Descarga del dataset
"""

!kaggle datasets download -d 'nicholasjhana/energy-consumption-generation-prices-and-weather'

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          12.  Descomprimir los archivos descargados.

- Extracci√≥n del contenido del archivo ZIP "energy-consumption-generation-prices-and-weather.zip"

- Descompresi√≥n y colocaci√≥n en la carpeta "data/", en el entorno de  -por defecto: colocar "/y"-
"""

!unzip energy-consumption-generation-prices-and-weather.zip -d data/y

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          13.  Cambio del directorio para darle continuidad al trabajo.

- Cambio al directorio "data, para luego listar los contenidos de ese directorio
- "&&" es un operador l√≥gico que se utiliza en comandos de shell
- En este contexto, "&&" significa "y". Lo que hace es ejecutar el segundo comando solo si el primero se ejecuta con √©xito, es decir, si el cambio de directorio a "data" tiene √©xito.
"""

!cd data && ls

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; text-align: left; color: black; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          14.  Continuaci√≥n del trabajo con la carga del dataset y de las librer√≠as necesarias, para pasar a la siguiente etapa de Data Wrangling.

- Empleo de pandas para cargar el dataset
"""

df_weather = pd.read_csv("/content/gdrive/MyDrive/data/y/weather_features.csv")

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Para este dataset se debe efectuar otro proceso de estructuraci√≥n y limpieza.
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Inicialmente se modificar√°n los tipos de datos, pasando los "int64" a "float64". Se incluyen las features presi√≥n; humedad; velocidad y direcci√≥n de viento; nubosidad y 'weather_id'.

- Chequeo sobre el tipo de datos
"""

df_weather.info()

"""- Identificaci√≥n de las columnas con un tipo de dato espec√≠fico, sumado a la conversi√≥n a otro dtype y devolviendo el dataframe modificado"""

def conversor(df_weather, convert_from, convert_to):
    columnas = df_weather.select_dtypes(include=[convert_from]).columns

    for col in columnas:
        df_weather[col] = df_weather[col].values.astype(convert_to)

    return df_weather

"""- Aplicaci√≥n de la funci√≥n convertidora de datos (int64 a float64)"""

df_weather = conversor(df_weather, np.int64, np.float64)

"""- Chequeo repetido en tipos de datos"""

df_weather.info()

"""- Establecimiento de la feature 'dt_iso' como index"""

df_weather.index = df_weather['dt_iso']
df_weather = df_weather.drop('dt_iso', axis='columns')

df_weather

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          Acondicinamiento del index en el dataframe.

- Seteo del index como un dtype=datetime, y seteo de sus valores con respecto a tiempo universal coordinado o UTC
    - UTC es el principal est√°ndar de tiempo por el cual el mundo regula los relojes y el tiempo
    - Chequeo de que el index sea un tipo de dtype=datetime
"""

df_weather.index = pd.to_datetime(df_weather.index, utc='True')

df_weather.index

"""- Empleo del comando tz_localize para remover el uso horario o time zone, manteniendo el resto de los valores temporales
    - Remoci√≥n del valor temporal de 2014, ya que no aporta a la data
"""

df_weather = df_weather.tz_localize(None)

df_weather = df_weather[df_weather.index.year >=2015]

df_weather.index

"""- Cambio en el nombre de la feature: de 'dt_iso' a 'time'"""

df_weather.index.name = 'time'

"""- Chequeo para revisar el nombre del index"""

print(df_weather.index)

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          An√°lisis de valores duplicados

- Utilizaci√≥n de "groupby" para las variables cuantitativas -agrupadas- por ciudad
"""

mean_values_city = df_weather.groupby('city_name').mean()

mean_values_city

"""- Aplicaci√≥n del m√©todo ".describe" para las variables cualitativas"""

df_weather.describe(include='object')

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Se puede concluir que la feature 'weather_id' no aporta al an√°lisis del trabajo, debido a que s√≥lamente representa una utilidad en fuente de informaci√≥n trabajando en el sitio web de OpenWeather.

- Despliegue de los valores √∫nicos en las features:
    - 'weather_description'
    - 'weather_main'
    - 'weather_id'
"""

wd_unique = df_weather['weather_description'].unique()

wd_unique

wm_unique = df_weather['weather_main'].unique()

wm_unique

wid_unique = df_weather['weather_id'].unique()

wid_unique

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        En materia de descripciones cualitativas, se tiene:
        <ul style="color: black; text-align: left;">
        <li>'weather_main' presenta una versi√≥n "m√°s simple" o menos detallada comparada con la 'weather_description'.
        <li>'weather_id' presenta una informaci√≥n precisa y √∫til, combin√°ndose de mejor forma con la de 'weather_description', ya que ambas, incluso, contienen casi el mismo n√∫mero de valores √∫nicos.
        </ul>
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Por lo tanto, no ser√≠a una mala idea eliminar 'weather_main', en virtud de mantener las otras dos.

- Conteo de valores NaNs en df_weather
"""

conteo_missing = df_weather.isnull().sum().sum()
print(f'Existen {conteo_missing} valores NaN en df_weather.')

"""- Conteo de registros duplicados en df_weather"""

conteo_dupplicated = df_weather.duplicated().sum()
print(f'Existen {conteo_dupplicated} valores/registros duplicados, basados en todas las columnas, en df_weather.')

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Pasos a seguir para la eliminaci√≥n de NaNs:
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        1. Inicialmente, se determina el n√∫mero de registros duplicados, agrup√°ndolos por ciudad.

- Conteo de registros en df_weather, para cada ciudad
"""

for city, group in df_weather.groupby('city_name'):
    print('Existen {} registros en df_weather en referencia a la ciudad de: {}.'
          .format(group.shape[0], city))

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        2. Se procede a emplear una eliminaci√≥n de duplicados, manteniendo el primer duplicado (por un lado) y manteniendo el √∫ltimo duplicado (por otro lado).
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Explicaci√≥n del m√©todo para mantenimiento de duplicados:
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Los dos bloques de c√≥digo realizar√°n una operaci√≥n de limpieza para los datos. Para el dataframe, se estar√≠an eliminando duplicados bas√°ndose en las columnas 'time' y 'city_name'.
        </p>
        La diferencia entre 'first' y 'last' en el par√°metro keep radica en qu√© duplicado se mantiene, y la elecci√≥n entre ambos m√©todos tiene una fuerte dependencia con la naturaleza de los datos y de qu√© duplicado se prefiera mantener.

- Creaci√≥n de un dataframe alternativo (df_weather_2) y eliminaci√≥n de los duplicados - manteniendo el √∫ltimo valor -
    - Si hubiese m√∫ltiples registros con los mismos valores de 'time' y 'city_name', se conservar√≠a la √∫ltima entrada (la m√°s reciente en el conjunto de datos)
"""

df_weather_2 = df_weather.reset_index().drop_duplicates(subset=['time', 'city_name'],
                                                        keep='last').set_index('time')

"""- Conteo de registros en df_weather_2, para cada ciudad"""

for city, group in df_weather_2.groupby('city_name'):
    print('Existen {} registros en df_weather_2 en referencia a la ciudad de: {}.'
          .format(group.shape[0], city))

"""- Se hace lo an√°logo en eliminaci√≥n de duplicados, pero con el dataframe original (df_weather) - manteniendo el primer valor -
    - Si hubiese m√∫ltiples registros con los mismos valores de 'time' y 'city_name', se conservar√≠a la primera entrada (la m√°s antigua en el conjunto de datos)
"""

df_weather = df_weather.reset_index().drop_duplicates(subset=['time', 'city_name'],
                                                      keep='first').set_index('time')

"""- Conteo de registros en df_weather, para cada ciudad"""

for city, group in df_weather.groupby('city_name'):
    print('Existen {} registros en df_weather en referencia a la ciudad de: {}.'
          .format(group.shape[0], city))

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        3. Por √∫ltimo, se aplica la t√©cnica de R cuadrado para evaluar y decidir sobre la eliminaci√≥n de las variables 'weather_main', 'weather_id', 'weather_description' y 'weather_icon' (columnas responsables de acarrear los valores duplicados).
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Se invita a consultar el siguiente <a href=https://docs.google.com/document/d/170KNyWPwnbt01WbgS1F_DlyRyRpC9Jc8yjNgVvbDjd4/edit?usp=sharing target="_blank"> extracto</a> para seguir la t√©cnica y metodolog√≠a empleada para decidir la eliminaci√≥n de las columnas mencionadas.
        <h1 style="border: 2px solid #f8f8f8; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        I. Explicaci√≥n: El autor comienza describiendo las caracter√≠sticas cualitativas de las columnas 'weather_main', 'weather_id', y 'weather_description' en t√©rminos de la informaci√≥n que contienen. Observa que 'weather_main' parece tener la informaci√≥n menos detallada, mientras que 'weather_id' y 'weather_description' son m√°s detalladas y tienen aproximadamente el mismo n√∫mero de valores √∫nicos.
        </p>
        II. Chequeo de Consistencia: Se menciona la importancia de verificar la consistencia de la informaci√≥n en estas columnas. Dado que el conjunto de datos conten√≠a filas duplicadas y se utilizaron dos dataframes diferentes para limpiarlo ('df_weather' y 'df_weather_2'), se propone utilizar el coeficiente de determinaci√≥n (R-squared) para comparar estos dos conjuntos de datos despu√©s de la codificaci√≥n de 'weather_description' y 'weather_main' de cadenas a etiquetas num√©ricas.
        </p>
        III. C√≥digo para Calcular R-Squared Score: Se define una funci√≥n "encode_and_display_r2_score" que calcula y muestra el coeficiente R-squared para una columna espec√≠fica entre dos dataFrames. Se aplica esta funci√≥n para 'weather_description', 'weather_main' (ambos codificados) y 'weather_id' (no codificado) para los dataframes 'df_weather' y 'df_weather_2'.
        </p>
        IV. Resultados del Coeficiente R-Squared: Los resultados indican que 'weather_description' tiene un coeficiente R-squared de 0.973, 'weather_main' tiene 0.963 y 'weather_id' tiene 0.921 (valores cercanos a 1 indican alta similitud).
        </p>
        V. Conclusi√≥n y acciones tomadas: Se concluye que hay inconsistencias en el conjunto de datos, ya que las columnas contienen grandes cantidades de duplicados. Se decide eliminar las columnas 'weather_main', 'weather_id', 'weather_description', y 'weather_icon' del DataFrame 'df_weather' probablemente debido a la alta correlaci√≥n y redundancia de informaci√≥n.

- Eliminaci√≥n de las features que no aportan informaci√≥n relevante al an√°lisis
"""

df_weather = df_weather.drop(['weather_main', 'weather_id',
                              'weather_description', 'weather_icon'], axis=1)

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
        Se opta por mantener los primeros duplicados ("keep='first'"), ya que las pruebas indican que no se hace una diferencia notoria con respecto a mantener los √∫ltimos duplicados ("keep='last'").

- Conteo de las filas duplicadas en df_weather, una vez eliminadas las variables que alteran el an√°lisis

- El argumento 'subset=['time', 'city_name']' especifica que se deben considerar duplicados s√≥lo cuando las columnas "time" y "city_name" tengan el mismo valor
"""

temp_weather = df_weather.reset_index().duplicated(subset=['time', 'city_name'],
                                                   keep='first').sum()
print('Existen {} valores/registros duplicados en df_weather ' \
      'bas√°ndose en todas las columnas, a excepci√≥n de "time" y "city_name".'.format(temp_weather))

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Publicaci√≥n de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Una vez que los datos est√°n validados, se pueden compartir para su uso, realizar an√°lisis exploratorios, entrenar modelos y tomar decisiones. Se entiende como un producto final que se entrega para ser usado".
        </p>
        Se procede a realizar el trabajo de Data Storytelling, motivo por el cual √©sta notebook se ha hido desarrollando de principio a fin.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 30px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          Validaci√≥n de los datos
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; padding: 5px; border-radius: 5px;">
          "Es muy importante para los equipos de trabajo ligados al √°rea de Data Science, asegurarse que los datos son precisos  y que la informaci√≥n no se alter√≥ durante el proceso. Esto significa asegurar la fiabilidad, credibilidad y calidad de los datos limpios debido a que van a utilizarse para tomar decisiones.".
        </p>
        Se pueden consultar las referencias empleadas m√°s arriba y comprobar que los datos garantizan calidad, precisi√≥n y fiabilidad.

---

### Exploratory Data Analysis (EDA)
<a id="9"></a>

<div style="width: 100%; text-align: center;">
  <div style="max-width: 600px; margin: 0 auto;">
    <div style="background-color: #DEB887; padding: 20px; border-radius: 10px;">
      <h1 style="border: 2px solid #f8f8f8; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #f5d769; font-size: 50px; padding: 5px; border-radius: 10px;">
        üìä Exploratory Data Analysis (EDA)
      </h1>
    </div>
  </div>
</div>

---

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 1. Evoluci√≥n de la demanda de energ√≠a en el pa√≠s. ¬øC√≥mo evoluciona la situaci√≥n de esta variable para los a√±os de estudio? ¬øQu√© comportamientos se muestran con respecto a su tendencia? ¬øQu√© se puede concluir respecto a un per√≠odo semanal de consumo?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Una caracter√≠stica que destaca a este tipo de variables (consumo/demanda) es su periodicidad diaria-semanal-mensual. A su vez, la variable deber√≠a presentar un comportamiento marcado, a escala diaria, que responda a las necesidades del sector consumidor seg√∫n el momento del d√≠a en particular.

- Empleo de los m√©todos ".describe" para realizar una breve estad√≠stica descriptiva de la feature, seg√∫n los a√±os de estudio (2015, 2016, 2017 y 2018)
"""

df_demand_2015 = df_energy[df_energy.index.year == 2015]['total load actual']
stats_2015 = df_demand_2015.describe().round(1)
load_table_2015 = pd.DataFrame(stats_2015)

load_table_2015

df_demand_2016 = df_energy[df_energy.index.year == 2016]['total load actual']
stats_2016 = df_demand_2016.describe().round(1)
load_table_2016 = pd.DataFrame(stats_2016)

load_table_2016

df_demand_2017 = df_energy[df_energy.index.year == 2017]['total load actual']
stats_2017 = df_demand_2017.describe().round(1)
load_table_2017 = pd.DataFrame(stats_2017)

load_table_2017

df_demand_2018 = df_energy[df_energy.index.year == 2018]['total load actual']
stats_2018 = df_demand_2018.describe().round(1)
load_table_2018 = pd.DataFrame(stats_2018)

load_table_2018

"""- Gr√°fico din√°mico para tratamiento de outliers en la variable demanda"""

pio.templates.default = "ggplot2"

df_energy_2015 = df_energy[df_energy.index.year == 2015]
df_energy_2016 = df_energy[df_energy.index.year == 2016]
df_energy_2017 = df_energy[df_energy.index.year == 2017]
df_energy_2018 = df_energy[df_energy.index.year == 2018]

load_hist_uni = px.histogram(df_energy, x='total load actual', nbins=30,
              title='Distribuci√≥n de Demanda Anual de Energ√≠a - Espa√±a (2015-2018)',
              labels={'total load actual': 'Demanda de Energ√≠a [MW]'},
              color_discrete_sequence=['#C79FEF'])
load_hist_uni.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
load_hist_uni.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
load_hist_uni.update_layout(legend_title='A√±o')

load_box_uni = px.box(df_energy, y='total load actual',
              title='Boxplot de Demanda Anual de Energ√≠a - Espa√±a (2015-2018)',
              labels={'total load actual': 'Demanda de Energ√≠a [MW]'},
              color_discrete_sequence=['#C79FEF'])
load_box_uni.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
load_box_uni.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
load_box_uni.update_layout(legend_title='A√±o')

load_hist_uni.show()
load_box_uni.show()

"""- Verificaci√≥n de normalidad en la variable demanda
    - Se hace uso del test de Shapiro
    - Esto imprimir√° finalmente un mensaje seg√∫n los datos sigan una distribuci√≥n normal, o no
"""

p_value = stats.shapiro(df_energy["total load actual"])[1]

print(p_value)

if p_value < 0.05:
    print("Los datos no siguen una distribuci√≥n normal")
else:
    print("Los datos siguen una distribuci√≥n normal")

"""- C√°lculo de par√°metros estad√≠sticos descriptivos de interes:
    - Media
    - Media recortada (proporci√≥n del 5% removida en cada cola)
    - Mediana
    - Moda
    - Desv√≠o est√°ndar
    - "IQR" (Rango intercuart√≠lico)
    - Rango
    - "MAD" (Media Absoluta de las Desviaciones)
    - "CV" (Coeficiente de Variaci√≥n)
    - Asimetr√≠a
    - Curtosis
- Empleo de un dataframe para visualizar los par√°metros calculados
"""

# Media
load_mean = np.mean(df_energy["total load actual"]).round(0)
# Media recortada
load_trim_mean = stats.trim_mean(df_energy["total load actual"], 0.05).round(0)
# Mediana
load_median = np.median(df_energy["total load actual"]).round(0)
# Moda
load_mode = stats.mode(df_energy["total load actual"])

# Cuartiles 1¬∞ y 3¬∞
load_q1 = stats.percentileofscore(df_energy["total load actual"], 25)
load_q3 = stats.percentileofscore(df_energy["total load actual"], 75)
# Desv√≠o est√°ndar
load_std = np.std(df_energy["total load actual"]).round(0)
# IQR
load_iqr = stats.iqr(df_energy["total load actual"]).round(0)
# Rango
load_range = max(df_energy["total load actual"]) - min(df_energy["total load actual"])
# MAD
mad = np.median(np.abs(df_energy["total load actual"] - load_median)).round(0)
# CV
load_cv = (stats.variation(df_energy["total load actual"])*100).round(2)

# Asimetr√≠a
load_skew = stats.skew(df_energy["total load actual"]).round(3)

# Curtosis
load_kurtosis = stats.kurtosis(df_energy["total load actual"]).round(3) # CA_p

df_load_estad√≠stica_descriptiva = pd.DataFrame({
    "Par√°metro estad√≠stico": ["Media", "Media recortada", "Mediana", "Moda", "Desv√≠o est√°ndar", "Rango intercuart√≠lico ", "Rango", "MAD (Media Absoluta de las Desviaciones)", "CV (Coeficiente de Variaci√≥n)", "Asimetr√≠a", "Curtosis"],
    "Valor": [load_mean, load_trim_mean, load_median, load_mode, load_std, load_iqr, load_range, mad, load_cv, load_skew, load_kurtosis]
})

df_load_estad√≠stica_descriptiva

"""- Gr√°fico interactivo para visualizar la evoluci√≥n temporal, promedio m√≥vil y tendencia
    - El promedio m√≥vil se calculo con una ventana de 7 d√≠as
    - Se debe resetear el index para que 'time' sea una columna
"""

pio.templates.default = "ggplot2"

# Promedio m√≥vil
load_promedio_movil = df_energy['total load actual'].rolling(window=7, min_periods=1).mean()
# Tendencia
tendencia_demanda = df_energy['total load actual'].diff()

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

fig = px.line(df_energy, x=df_energy.index, y='total load actual',
              title='Demanda Anual de Energ√≠a en Espa√±a (2015-2018)',
              labels={'total load actual': 'Demanda de Energ√≠a [MW]'},
              color_discrete_sequence=['#C79FEF'])
fig.add_scatter(x=df_energy.index, y=load_promedio_movil,
                mode='lines', name='Promedio m√≥vil (7 d√≠as)', line=dict(color='purple'))
fig.add_scatter(x=df_energy.index, y=tendencia_demanda,
                mode='lines', name='Tendencia de la Demanda', line=dict(color='black'))
fig.update_xaxes(
    rangeslider_visible=True,
    rangeselector=dict(
        buttons=list([
            dict(count=1, label="1 mes", step="month", stepmode="backward"),
            dict(count=6, label="6 meses", step="month", stepmode="backward"),
            dict(count=1, label="1 a√±o", step="year", stepmode="backward"),
            dict(label= "Todos los registros", step="all")
        ])
    )
)
fig.update_xaxes(title='Per√≠odo temporal',)
fig.update_yaxes(title='Demanda de Energ√≠a [MW]')
fig.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_layout(showlegend=True)
fig.show()

"""- Gr√°fico interactivo para visualizar la evoluci√≥n temporal por trimestres
    - Se agrupan los datos por trimestre y se calcula la suma
"""

pio.templates.default = "ggplot2"

quarterly_demand = df_energy.resample('Q').sum()
quarterly_demand_df = pd.DataFrame({
    'Trimestre-A√±o': quarterly_demand.index.strftime('%b %Y'),
    'Demanda energ√©tica [MW]': quarterly_demand['total load actual']
})

fig = px.bar(quarterly_demand_df, x='Trimestre-A√±o', y='Demanda energ√©tica [MW]',
             title='Evoluci√≥n Trimestral de la Demanda de Energ√≠a en Espa√±a (2015-2018)',
             color_discrete_sequence=['#C79FEF'])
fig.update_xaxes(title='Trimestre-A√±o', tickangle=45)
fig.update_yaxes(title='Demanda energ√©tica [MW]')
fig.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- El an√°lisis univariado arroja que la variable demanda sigue una distribuci√≥n no normal de los datos. Tambi√©n, su distribuci√≥n presenta cierto grado de simetr√≠a y es platic√∫rtica -curtosis negativa-. Por √∫ltimo, el CV (de aproximadamente 16%) indica que la media es representativa del conjunto de datos -conjunto de datos homog√©neo-.
        </p>
        üí°- La evoluci√≥n de la demanda para los 4 a√±os es de un comportamiento muy fluctuante, por lo que no es del todo seguro afirmar de forma directa que se cuenta con una tendencia creciente o decreciente.
        </p>
        üí°- La tendencia revela que para los meses de verano e invierno se supera el piso de los 30.000 MW demandados, lo cual es un valor elevado de consumo.
        </p>
        üí°- La demanda acumulada por trimestre indica que se comienza con un valor elevado de consumo al iniciarse el a√±o (periodo invernal). De igual forma, al final del a√±o, la demanda acumulada mensual se "dispara" a valores elevados.
        </p>
        üí°- La demanda acumulada mensual durante los meses de verano tambi√©n alcanza valores elevados -meses como enero y marzo (tambi√©n julio) son los responsables de que se alcancen picos muy elevados para esta variable.
        </p>
        üí°- El consumo se mantiene elevado en el per√≠odo de d√≠as laborales (lun-vie) y luego decae en el per√≠odo de los d√≠as de fin de semana, en un intervalo de 5-2. Tambi√©n, presenta dos picos en las horas del mediod√≠a y de las 20 hs de la noche, raz√≥n que es explicada por la mayor actividad y permanencia de la poblaci√≥n en sus hogares.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 2. Variable precio. ¬øQu√© resultados se observan, haciendo un an√°lisis estad√≠stico descriptivo e inferencial, sobre la variable target?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Es acertado, para efectuar un an√°lisis b√°sico, realizar un histograma para visualizar los valores que adoptan las diferentes distribuciones, seg√∫n todo el per√≠odo evaluado, y seg√∫n para cada a√±o en particular.

- Gr√°fico interactivo para analizar la distribuci√≥n de los valores del precio
"""

pio.templates.default = "ggplot2"

fig = px.histogram(df_energy, x='price actual', color=df_energy.index.year, nbins=30,
                   title='Distribuci√≥n de valores para el precio de energ√≠a el√©ctrica - Espa√±a (2015-2018)',
                   labels={'price actual': 'Precio de energ√≠a el√©ctrica [‚Ç¨/MWh]'},
                   # facet_col=df_energy.index.year.astype(str),
                   marginal='rug')
fig.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(title= 'Conteo', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_layout(legend_title='A√±o')

fig.show()

"""- Verificaci√≥n de normalidad en la variable precio
    - Se hace uso del test de Shapiro
    - Esto imprimir√° finalmente un mensaje seg√∫n los datos sigan una distribuci√≥n normal, o no
"""

p_value = stats.shapiro(df_energy["price actual"])[1]

print(p_value)

if p_value < 0.05:
    print("Los datos no siguen una distribuci√≥n normal")
else:
    print("Los datos siguen una distribuci√≥n normal")

"""- C√°lculo de par√°metros estad√≠sticos descriptivos de interes:
    - Media
    - Media recortada (proporci√≥n del 5% removida en cada cola)
    - Mediana
    - Moda
    - Desv√≠o est√°ndar
    - "IQR" (Rango intercuart√≠lico)
    - Rango
    - "MAD" (Media Absoluta de las Desviaciones)
    - "CV" (Coeficiente de Variaci√≥n)
    - Asimetr√≠a
    - Curtosis
- Empleo de un dataframe para visualizar los par√°metros calculados
"""

# Media
load_mean = np.mean(df_energy["price actual"]).round(0)
# Media recortada
load_trim_mean = stats.trim_mean(df_energy["price actual"], 0.05).round(0)
# Mediana
load_median = np.median(df_energy["price actual"]).round(0)
# Moda
load_mode = stats.mode(df_energy["price actual"])

# Cuartiles 1¬∞ y 3¬∞
load_q1 = stats.percentileofscore(df_energy["price actual"], 25)
load_q3 = stats.percentileofscore(df_energy["price actual"], 75)
# Desv√≠o est√°ndar
load_std = np.std(df_energy["price actual"]).round(0)
# IQR
load_iqr = stats.iqr(df_energy["price actual"]).round(0)
# Rango
load_range = max(df_energy["price actual"]) - min(df_energy["price actual"])
# MAD
mad = np.median(np.abs(df_energy["price actual"] - load_median)).round(0)
# CV
load_cv = (stats.variation(df_energy["price actual"])*100).round(2)

# Asimetr√≠a
load_skew = stats.skew(df_energy["price actual"]).round(3) # CA

# Curtosis
load_kurtosis = stats.kurtosis(df_energy["price actual"]).round(3) # CA_p

df_load_estad√≠stica_descriptiva = pd.DataFrame({
    "Par√°metro estad√≠stico": ["Media", "Media recortada", "Mediana", "Moda", "Desv√≠o est√°ndar", "Rango intercuart√≠lico ", "Rango", "MAD (Media Absoluta de las Desviaciones)", "CV (Coeficiente de Variaci√≥n)", "Asimetr√≠a", "Curtosis"],
    "Valor": [load_mean, load_trim_mean, load_median, load_mode, load_std, load_iqr, load_range, mad, load_cv, load_skew, load_kurtosis]
})

df_load_estad√≠stica_descriptiva

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- El an√°lisis univariado arroja que la variable target sigue una distribuci√≥n no normal de los datos. Tambi√©n, su distribuci√≥n es sim√©trica y es platic√∫rtica -curtosis negativa-. Por √∫ltimo, el CV (de aproximadamente 25%) indica que la media es representativa del conjunto de datos -conjunto de datos homog√©neo-.
        </p>
        üí°- La distribuci√≥n del precio para el a√±o 2017 es la que mas centrada se encuentra con respecto a un precio cercano a 60 ‚Ç¨/MWh, ya que no presenta un corrimiento de la media hacia valores m√°s peque√±os o m√°s grandes, y adem√°s es una distribuci√≥n unimodal.
        </p>
        üí°- Caso contrario, es el de la variable para el a√±o 2016, la cual se corre hacia la izquierda, para el 2018 en la cual sucede lo mismo pero para la derecha.
        </p>
        üí°- La distribuci√≥n para el a√±o 2015 presenta una distribuci√≥n bimodal, y tiene mucha presencia hacia la derecha del valor que se toma como referencia (60 ‚Ç¨/MWh).

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 3. Evoluci√≥n temporal para el precio. ¬øC√≥mo se comporta el precio de la energ√≠a el√©ctrica a lo largo del per√≠odo considerado? ¬øC√≥mo se lleva a cabo la descomposici√≥n de la serie temporal, y qu√© se puede determinar realizando √©sto? ¬øQu√© sucede con la estacionalidad de la serie temporal?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se hace una una descomposici√≥n de la serie temporal (de forma aditiva y multiplicativa) -obteniendo la tendencia, estacionalidad y valores residuales-.
        </p>
        Para valerse de predicciones acertadas y eficientes, se debe comprobar que la serie temporal sea estacionaria, esto se llevar√° a cabo con una prueba espec√≠fica (a detallar m√°s adelante). Una serie temporal estacionaria deber√≠a presentar una media y varianza constantes en el tiempo analizado, de no presentarse esta condici√≥n en la serie, se har√° uso de algunos m√©todos para modificar la serie de tiempo, y volverla estacionaria (diferenciaci√≥n, logaritmos, etc.).

- Gr√°fico interactivo de descomposici√≥n aditiva para el precio
- Componentes de la descomposici√≥n:
    - Tendencia
    - Estacionalidad
    - Residuos
"""

pio.templates.default = "ggplot2"

result = sm.tsa.seasonal_decompose(df_energy['price actual'], model='aditive')

tendencia = result.trend
estacionalidad = result.seasonal
residuos = result.resid

colors = {'Tendencia': 'black', 'Estacionalidad': '#316395', 'Residuos': '#FF9900'}

df_decomposition = pd.concat([tendencia, estacionalidad, residuos], axis=1)
df_decomposition.columns = ['Tendencia', 'Estacionalidad', 'Residuos']

fig = px.line(df_decomposition, x=df_decomposition.index, y=df_decomposition.columns,
              title='Descomposici√≥n Aditiva de la variable Precio de la energ√≠a el√©ctrica - Espa√±a (2015-2018)',
              labels={'value': 'Valor', 'variable': 'Componente'},
              facet_col=df_decomposition.index.year.astype(str),
              facet_col_spacing=0.05,
              color_discrete_map=colors)
fig.update_xaxes(title= 'Per√≠odo temporal', showline=True, linewidth=1.5, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=1.5, linecolor='black', mirror=True)
fig.update_layout(legend_title='Componente')

fig.show()

"""- Gr√°fico interactivo de descomposici√≥n multiplicativa para el precio
- Componentes de la descomposici√≥n:
    - Tendencia
    - Estacionalidad
    - Residuos
"""

pio.templates.default = "ggplot2"


result = sm.tsa.seasonal_decompose(df_energy['price actual'], model='multiplicative')

tendencia = result.trend
estacionalidad = result.seasonal
residuos = result.resid

colors = {'Tendencia': 'black', 'Estacionalidad': '#316395', 'Residuos': '#FF9900'}

df_decomposition = pd.concat([tendencia, estacionalidad, residuos], axis=1)
df_decomposition.columns = ['Tendencia', 'Estacionalidad', 'Residuos']

fig = px.line(df_decomposition, x=df_decomposition.index, y=df_decomposition.columns,
              title='Descomposici√≥n Multiplicativa de la variable Precio de la energ√≠a el√©ctrica - Espa√±a (2015-2018)',
              labels={'value': 'Valor', 'variable': 'Componente'},
              facet_col=df_decomposition.index.year.astype(str),
              facet_col_spacing=0.05,
              color_discrete_map=colors)
fig.update_xaxes(title= 'Per√≠odo temporal', showline=True, linewidth=1.5, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=1.5, linecolor='black', mirror=True)
fig.update_layout(legend_title='Componente')

fig.show()

"""- Para acompa√±ar las visualizaciones generadas en los interrogantes 3 y 4, se realiza la prueba de ADF para la variable precio.

- Para m√°s informaci√≥n, es de mucha utilidad consultar el siguiente <a href="https://docs.google.com/document/d/1ixIAQ6HKcRulq3-Wat1rkyBKYz0OWRlErsFRbvV3wrw/edit?usp=sharing" target="_blank"> documento</a>, con recopilaci√≥n bibliogr√°fica para √©ste tema.

- Las hip√≥tesis empleadas son las siguientes:

  - Hip√≥tesis nula (H0):
    - Existe una ra√≠z unitaria en la ST -con estructura dependiente del tiempo- (por ejemplo, la serie est√° autocorrelacionada con un r=1), ergo, no es estacionaria.
  - Hip√≥tesis alternativa (HA):
    - La ST no contiene una ra√≠z unitaria, y es estacionaria o puede serlo a partir de una diferenciaci√≥n.
"""

y = df_energy['price actual']
adf_test = adfuller(y, regression='c')

print('Estad√≠stico ADF: {:.6f}\np-value: {:.6f}\n#Lags usados: {}'
      .format(adf_test[0], adf_test[1], adf_test[2]))
for key, value in adf_test[4].items():
    print('Valor cr√≠tico ({}): {:.6f}'.format(key, value))

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- El p-value para la ADF es mucho m√°s peque√±o que 0.05, por ende, la ST se define como estacionaria con un 5% de significancia. Adem√°s, el estad√≠stico de prueba ADF (-9.148003) es menor que el valor cr√≠tico para un 1% de significancia (-3.430537), por lo tanto se rechaza la hip√≥tesis nula, abrazando la alternativa, ahora con 1% de significancia.
        </p>
        üí°- La tendencia de la variable precio modifica su comportamiento seg√∫n las estaciones en las que se encuentre analizada √©sta: no es posible determinar un comportamiento regular en el tiempo. Sin embargo, existe una marcada subida del precio en el inicio del a√±o 2017.
        </p>
        üí°- Como primera observaci√≥n, el componente residual parece presentar un comportamiento caracter√≠stico de una variable que tiene anomal√≠as en los primeros meses de cada a√±o.
        </p>

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 4. Evoluci√≥n temporal para el precio. ¬øC√≥mo se comporta el precio de la energ√≠a el√©ctrica analizando cada a√±o en particular?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se analizar√°n ciertos comportamientos empleando elementos tales como: tendencia y promedio m√≥vil simple para cada a√±o en particular.
        </p>
        Un buen aporte al an√°lisis es el de revelar qu√© sucede con la variable precio en per√≠odos m√°s acortados, por ejemplo: a escalas mensuales (√≠dem para lo realizado con la variable demanda).

- Gr√°fico interactivo para visualizar el precio, teniendo en cuenta:
    - Evoluci√≥n temporal
    - Promedio m√≥vil
    - Tendencia
"""

pio.templates.default = "ggplot2"

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

tendencia_precio = df_energy['price actual'].diff()

load_promedio_movil_2 = df_energy['price actual'].rolling(window=7, min_periods=1).mean()

fig_precio = px.line(df_energy, x=df_energy.index, y='price actual',
              title='Evoluci√≥n del precio de energ√≠a el√©ctrica - Espa√±a (2015-2018)',
              labels={'price actual': 'Precio energ√©tico [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_precio.add_scatter(x=df_energy.index, y=load_promedio_movil_2,
                mode='lines', name='Promedio m√≥vil (7 d√≠as)')
fig_precio.update_xaxes(
    rangeslider_visible=True,
    rangeselector=dict(
        buttons=list([
            dict(count=1, label="1 mes", step="month", stepmode="backward"),
            dict(count=6, label="6 meses", step="month", stepmode="backward"),
            dict(count=1, label="1 a√±o", step="year", stepmode="backward"),
            dict(label= "Todos los registros", step="all")
        ])
    ),
    title_text="Per√≠odo temporal"
)
fig_precio.update_yaxes(title_text="Precio de Energ√≠a [‚Ç¨/MWh]")

fig_tendencia_precio = px.line(df_energy, x=df_energy.index, y=tendencia_precio,
                title='Tendencia del Precio de Energ√≠a El√©ctrica - Espa√±a (2015-2018)',
                labels={'y': 'Tendencia del Precio [‚Ç¨/MWh]'},
                color_discrete_sequence=['black'])
fig_tendencia_precio.update_xaxes(
    rangeslider_visible=True,
    rangeselector=dict(
        buttons=list([
            dict(count=1, label="1 mes", step="month", stepmode="backward"),
            dict(count=6, label="6 meses", step="month", stepmode="backward"),
            dict(count=1, label="1 a√±o", step="year", stepmode="backward"),
            dict(label= "Todos los registros", step="all")
        ])
    ),
    title_text="Per√≠odo temporal"
)
fig_tendencia_precio.update_yaxes(title_text="Tendencia del Precio [‚Ç¨/MWh]")

fig_precio.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_precio.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_tendencia_precio.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_tendencia_precio.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_precio.show()
fig_tendencia_precio.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- El precio se mantiene en valores altos durante los meses de invierno.
        </p>
        üí°- Se destaca la gran subida que se observa en todos los a√±os para el mes de enero. Sin embargo, pasado este mes, comienza a decaer el valor. Durante los meses de verano para los a√±os estudiados (salvo para el a√±o 2017), se observa una lenta, pero visible tendencia positiva del precio de la energ√≠a.
        </p>
        üí°- Entre el cierre del a√±o 2016 e inicio del 2017, se observ√≥ el pico m√°s alto en lo que respecta al valor del precio.
        </p>
        üí°- Durante los meses de marzo-abril-mayo, el precio alcanza valores muy bajos, para todos los a√±os estudiados.
        </p>
        üí°- El precio tiene un componente estacional muy presente, debido a los distintos comportamientos que presenta el sector consumidor acorde a las estaciones.
        </p>
        üí°- El precio, an√°logo a la demanda, presenta un comportamiento peculiar durante los d√≠as de una semana est√°ndar: siendo alto durante los d√≠as laborales (lun-vie) y bajo durante los fines de semana.
        </p>
        üí°- El precio durante las horas de sue√±o (o altas horas de la noche) tiende a disminuir, mientras que durante el resto del d√≠a presenta dos subidas de valor, las cuales son durante el mediod√≠a y durante la tarde-noche.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 5. ¬øQu√© relaci√≥n se puede establecer, a grandes rasgos, entre la variable demanda y el precio fijado de la energ√≠a el√©ctrica?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Mediante un gr√°fico de dispersi√≥n, se deber√≠a obtener una conclusi√≥n certera sobre la relaci√≥n entre estas variables.
        </p>
        Seg√∫n expertos en el sector energ√©tico y en los trabajos bibliogr√°ficos consultados, cuando la demanda sube, el precio, generalmente, lo hace tambi√©n.
        </p>
        Recordando de prestar especial atenci√≥n al "mix" energ√©tico con el que el sector generador de la energ√≠a abastece a la poblaci√≥n: haciendo que el precio suba o baje seg√∫n var√≠e la combinaci√≥n entre generaci√≥n por combustibles f√≥siles y fuentes renovables de energ√≠a (70%-30%, 50%-50%, etc.).

- Gr√°fico interactivo entre demanda y precio - scatterplot -
- An√°lisis de regresi√≥n lineal
    - Split entre data train/test (70-30)
    - Obtenci√≥n de par√°metros
- An√°lisis de regresi√≥n no lineal - polin√≥mica de grado 2 -
    - Obtenci√≥n de par√°metros
- Obtenci√≥n de coeficiente de correlaci√≥n, seg√∫n
- Impresi√≥n de los datos obtenidos
"""

pio.templates.default = "ggplot2"

df_2015_2018 = df_energy[(df_energy.index.year >= 2015) & (df_energy.index.year <= 2018)]

fig = px.scatter(df_2015_2018, x='price actual', y='total load actual', color=df_2015_2018.index.year,
                 title='Precio vs Demanda - A√±os 2015-2018',
                 labels={'price actual': 'Precio [‚Ç¨/MWh]', 'total load actual': 'Demanda [MW]'},
                 trendline='ols')
fig.update_xaxes(title='Precio [‚Ç¨/MWh]', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(title='Demanda [MW]', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_traces(marker=dict(size=2.5))
fig.update_layout(
    coloraxis_colorbar=dict(
        title='A√±o',
        tickvals=[2015, 2016, 2017, 2018],
        ticktext=['2015', '2016', '2017', '2018']
    ))

fig.show()

X_train, X_test, y_train, y_test = train_test_split(df_energy[['price actual']], df_energy['total load actual'], test_size=0.3)

lr = LinearRegression()
lr.fit(X_train, y_train)

a = lr.intercept_
b = lr.coef_[0]

poly_features = PolynomialFeatures(degree=2)
X_poly = poly_features.fit_transform(df_energy[['price actual']])

lr = LinearRegression()
lr.fit(X_poly, df_energy['total load actual'])

a = lr.intercept_
b = lr.coef_[0]
c = lr.coef_[1]

r, p = pearsonr(df_energy['price actual'], df_energy['total load actual'])

print(f'Ecuaci√≥n de regresi√≥n: Y = {round(a, 2)} + {round(b, 2)}X')
print(f'Ecuaci√≥n de regresi√≥n: Y = {round(a, 2)} + {round(b, 2)}X + {round(c, 2)}X^2')
print(f'Coeficiente de Pearson: {round(r, 2)}')

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- En la mayor√≠a de las ocasiones relacionales que forman al gr√°fico, la variable precio aumenta a medida que la demanda lo hace tambi√©n.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 6. Relaciones con la variable precio. ¬øQu√© relaci√≥n se puede establecer, a grandes rasgos, entre la variable target y las dem√°s features?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Mediante un esquema gr√°fico de mapa de calor, que sigue el m√©todo de Pearson, se buscar√° determinar si existe una relaci√≥n fuerte del tipo lineal entre las variables de generaci√≥n convencional, generaci√≥n renovable, consumo y variable precio (target).
        </p>
        De no asegurar la completa linealidad entre las features mencionadas con la target, se buscar√° analizar la correlaci√≥n desde otros puntos de vista.

- Creaci√≥n de la matriz de correlaci√≥n - heatmap -
- Creaci√≥n de una tabla - df - con las correlaciones m√°s fuertes impresas
"""

correlaciones_energy = df_energy.corr(method='pearson')
filas = correlaciones_energy.index.tolist()
columnas = correlaciones_energy.columns.tolist()

correlaciones = []
for i, fila in enumerate(filas):
    for j, columna in enumerate(columnas):
        correlacion = correlaciones_energy.iloc[i, j]
        correlaciones.append((fila, columna, correlacion))

data = {'filas': [x[0] for x in correlaciones], 'columnas': [x[1] for x in correlaciones], 'correlaciones': [x[2] for x in correlaciones]}
source = ColumnDataSource(data)
mapper = linear_cmap(field_name='correlaciones', palette=Viridis256, low=-1, high=1)

p = figure(x_range=filas, y_range=columnas, width=1000, height=800, tooltips=[('Filas', '@filas'), ('Columnas', '@columnas'), ('Correlaci√≥n', '@correlaciones{0.00}')])
p.rect(x='filas', y='columnas', width=1, height=1, source=source,
       line_color='white', fill_color=mapper)
p.xaxis.major_label_orientation = 3.14 / 4
p.title.text = 'Matriz de Correlaciones - M√©todo Pearson'
p.outline_line_color = 'black'
p.outline_line_width = 4
color_bar = ColorBar(color_mapper=mapper['transform'], width=8, location=(0, 0))
p.add_layout(color_bar, 'right')
p.add_tools(HoverTool())

output_notebook("multivariado_principal.html")

output_notebook()
show(p)

correlacion_positiva = abs(correlaciones_energy[correlaciones_energy > 0.5])
fuerte_correlacion = correlacion_positiva[correlacion_positiva < 1.0].stack().reset_index()
fuerte_correlacion.columns = ['Variable A', 'Variable B', 'Correlaci√≥n']

fuerte_correlacion

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- Los valores de correlaci√≥n no son tales como para asegurar una correlaci√≥n completamente lineal, a excepci√≥n de demanda-precio.
        </p>
        üí°- Existe un leve indicio alto de correlaci√≥n positiva entre las variables de generaci√≥n a partir de recursos convencionales (gas natural, carb√≥n y fueloil) y el precio. A medida que la generaci√≥n a partir de las convencionales aumenta, el precio lo hace tambi√©n.
        </p>
        üí°- Hay una correlaci√≥n baja y tendiendo a ser negativa entre las energ√≠as obtenidas a partir de fuentes renovables (hidroel√©ctricas, solar, biomasa, e√≥lica, etc.). Reiterando, a medida que la generaci√≥n de las renovables aumenta el precio deber√≠a disminuir su valor.
        </p>
        üí°- La variable demanda presenta la relaci√≥n lineal positiva m√°s fuerte entre todas las features. A mayores valores de consumo, el sector de productores energ√©ticos tendr√° mayores posibilidades de ofrecer su energ√≠a producida a valores m√°s elevados.
        </p>
        üí°- Las variables de generaci√≥n a partir de carb√≥n marr√≥n y carb√≥n duro presentan una correlaci√≥n positiva, esto es debido a que ambas comparten la misma materia prima para producir electricidad.
        </p>
        üí°- An√°logo a lo anterior, es para las variables renovables de generaci√≥n hidroel√©ctrica (fluyente y reservorio) y de biomasa/otras renovables.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 7. Generaci√≥n energ√©tica. ¬øQu√© se puede observar cuando se analiza la distribuci√≥n de valores en un histograma para cada variable?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        La flexibilidad a la hora de generar energ√≠a el√©ctrica, lo cual depende del tipo de materia prima empleada, proceso productivo y condicionantes del mercado -tanto internos como externos-, es fundamental para entender estas variables.
        </p>
        Variables que presenten una curva de distribuci√≥n con alta variabilidad, ser√°n aquellas que con una alta seguridad, presenten una gran capacidad para ser flexibles en su producci√≥n: lo cual les otorga un gran margen de maniobra para atender las necesidades del mercado.

- Gr√°fico interactivo entre distribuciones de variables de producci√≥n el√©ctrica
- Se crea el df empleando el m√©todo "melt"
"""

variables_hist = ['generation fossil gas', 'generation fossil hard coal', 'generation fossil brown coal/lignite',
                  'generation fossil oil', 'generation hydro water reservoir', 'generation hydro pumped storage consumption',
                  'generation hydro run-of-river and poundage', 'generation nuclear', 'generation solar',
                  'generation wind onshore', 'generation biomass', 'generation other', 'generation other renewable',
                  'generation waste']
color_palette = ['#929591', '#D1B26F', '#653700', '#FBDD7E', '#4C78A8', '#0099C6', '#19D3F3', '#BBF90F', '#FFA500',
                 '#069AF3', '#006400', '#620042', '#DA60CA', '#33FF6A']

df_melted = pd.melt(df_energy, value_vars=variables_hist, var_name='Variable', value_name='Value')

fig = px.histogram(df_melted, x='Value', color='Variable', nbins=30, color_discrete_map={var: color for var, color in zip(variables_hist, color_palette)})
fig.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_layout(title='Histogramas de Generaci√≥n de Energ√≠a - Espa√±a (2015-2018)', title_font_size=18)

fig.show()

"""- Verificaci√≥n de normalidad en las variables de generaci√≥n - 'variables_hist' -
    - Se hace uso del test de Shapiro
    - Esto imprimir√° finalmente un mensaje seg√∫n los datos sigan una distribuci√≥n normal, o no
"""

def test_normalidad(x):
    p_value = shapiro(x)[1]
    if p_value < 0.05:
        return f"Los datos no siguen una distribuci√≥n normal (p-value = {p_value})"
    else:
        return f"Los datos siguen una distribuci√≥n normal (p-value = {p_value})"

for variable in df_energy.columns:
    if variable in variables_hist:
        print(f"Variable: {variable} --- Resultado: {test_normalidad(df_energy[variable])}")

"""- Se utiliza un ciclo "for"
- Inicia con un df vac√≠o y se itera sobre cada variable
- Luego, se calculan los par√°metros estad√≠sticos descriptivos de interes:
    - Media
    - Media recortada (proporci√≥n del 5% removida en cada cola)
    - Mediana
    - Moda
    - Desv√≠o est√°ndar
    - "IQR" (Rango intercuart√≠lico)
    - Rango
    - "MAD" (Media Absoluta de las Desviaciones)
    - "CV" (Coeficiente de Variaci√≥n)
    - Asimetr√≠a
    - Curtosis
- Empleo de un dataframe para visualizar los par√°metros calculados
    -  Se agrega una fila con los datos al df inicial
"""

df_stats = pd.DataFrame()

for variable in variables_hist:

    # Media
    load_mean = np.mean(df_energy[variable]).round(0)
    # Media recortada
    load_trim_mean = stats.trim_mean(df_energy[variable], 0.05).round(0)
    # Mediana
    load_median = np.median(df_energy[variable]).round(0)
    # Moda
    load_mode = stats.mode(df_energy[variable])

    # Cuartiles 1¬∞ y 3¬∞
    load_q1 = stats.percentileofscore(df_energy[variable], 25)
    load_q3 = stats.percentileofscore(df_energy[variable], 75)
    # Desv√≠o est√°ndar
    load_std = np.std(df_energy[variable]).round(0)
    # IQR
    load_iqr = stats.iqr(df_energy[variable]).round(0)
    # Rango
    load_range = max(df_energy[variable]) - min(df_energy[variable])
    # MAD
    mad = np.median(np.abs(df_energy[variable] - load_median)).round(0)
    # CV
    load_cv = (stats.variation(df_energy[variable])*100).round(2)

    # Asimetr√≠a
    load_skew = stats.skew(df_energy[variable]).round(3)
    # Curtosis
    load_kurtosis = stats.kurtosis(df_energy[variable]).round(3)

    df_stats = df_stats.append({
        "Variable": variable,
        "Media": load_mean,
        "Media Recortada": load_trim_mean,
        "Mediana": load_median,
        "Moda": load_mode,
        "Q1": load_q1,
        "Q3": load_q3,
        "Desviaci√≥n Est√°ndar": load_std,
        "Rango Intercuart√≠lico": load_iqr,
        "Rango": load_range,
        "Desviaci√≥n Media Absoluta": mad,
        "Coeficiente de Variaci√≥n": load_cv,
        "Asimetr√≠a": load_skew,
        "Curtosis": load_kurtosis
    }, ignore_index=True)

df_stats

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- El an√°lisis univariado arroja que ninguna variable de generaci√≥n el√©ctrica sigue una distribuci√≥n no normal de los datos.
        </p>
        üí°- El caso de las centrales t√©rmicas que emplean combustibles f√≥siles (gas natural, fueloil y carb√≥n) es llamativo por su alta flexibilidad -como se coment√≥ al iniciar el interrogante.-.
        </p>
        üí°- Las centrales nucleares poseen un comportamiento muy particular. Trabajan a plena potencia, y es por ello que cuando operan, sus niveles de participaci√≥n en materia de generaci√≥n son muy constantes y asentados (cerca de 5000, 6000 y 7000 MW generados, respectivamente).
        </p>
        üí°- Para variables dependientes de los recursos climatol√≥gicos (sector e√≥lico, solar e hidroel√©ctrico), presentan niveles de generaci√≥n condicionados por los recursos clim√°ticos (vientos, presencia de luz solar, nubosidad y lluvias), adem√°s de los niveles de potencia instalada que tienen cada una de estas centrales generadores. Por ende, a medida que las condiciones climatol√≥gicas cambian, este sector aprovecha su capacidad, ya que no presentan un grado de flexibilidad adecuado (caso contrario a los productores que emplean combustibles f√≥siles).

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 8. Valores por a√±o de la variable target. ¬øQu√© an√°lisis se puede realizar teniendo en cuenta los valores del precio, seg√∫n cada a√±o?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se utilizar√°n gr√°ficos del tipo boxplot, los cuales ayudan a entender el comportamiento del sector productivo de energ√≠a el√©ctrica.
        </p>
        Este punto del an√°lisis es importante, ya que seg√∫n bibliograf√≠a y autores consultados, se afirma que este sector tiene una participaci√≥n directa en la fijaci√≥n del precio energ√©tico, siendo los √∫nicos entes que ofertan la energ√≠a.

- Gr√°fico din√°mico para tratamiento de outliers en la variable precio (discriminado para a√±os de estudio 2015, 2016, 2017 y 2018)
    - Combinaci√≥n entre histograma y boxplot
"""

pio.templates.default = "ggplot2"

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

df_energy_2015 = df_energy[df_energy.index.year == 2015]

fig_2015 = px.histogram(df_energy_2015, x='price actual', nbins=30,
              title='Distribuci√≥n de Precio de Energ√≠a El√©ctrica - Espa√±a (2015)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_2015.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2015.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2015.update_layout(legend_title='A√±o')

fig_boxplot_2015 = px.box(df_energy_2015, y='price actual',
              title='Boxplot de Precio de Energ√≠a El√©ctrica - Espa√±a (2015)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_boxplot_2015.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2015.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2015.update_layout(legend_title='A√±o')

fig_2015.show()
fig_boxplot_2015.show()

pio.templates.default = "ggplot2"

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

df_energy_2016 = df_energy[df_energy.index.year == 2016]

fig_2016 = px.histogram(df_energy_2016, x='price actual', nbins=30,
              title='Distribuci√≥n de Precio de Energ√≠a El√©ctrica - Espa√±a (2016)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_2016.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2016.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2016.update_layout(legend_title='A√±o')

fig_boxplot_2016 = px.box(df_energy_2016, y='price actual',
              title='Boxplot de Precio de Energ√≠a El√©ctrica - Espa√±a (2016)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_boxplot_2016.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2016.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2016.update_layout(legend_title='A√±o')

fig_2016.show()
fig_boxplot_2016.show()

pio.templates.default = "ggplot2"

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

df_energy_2017 = df_energy[df_energy.index.year == 2017]

fig_2017 = px.histogram(df_energy_2017, x='price actual', nbins=30,
              title='Distribuci√≥n de Precio de Energ√≠a El√©ctrica - Espa√±a (2017)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_2017.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2017.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2017.update_layout(legend_title='A√±o')

fig_boxplot_2017 = px.box(df_energy_2017, y='price actual',
              title='Boxplot de Precio de Energ√≠a El√©ctrica - Espa√±a (2017)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_boxplot_2017.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2017.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2017.update_layout(legend_title='A√±o')

fig_2017.show()
fig_boxplot_2017.show()

pio.templates.default = "ggplot2"

df_energy.reset_index(inplace=True)
df_energy['time'] = pd.to_datetime(df_energy['time'])
df_energy.set_index('time', inplace=True)

df_energy_2018 = df_energy[df_energy.index.year == 2018]

fig_2018 = px.histogram(df_energy_2018, x='price actual', nbins=30,
              title='Distribuci√≥n de Precio de Energ√≠a El√©ctrica - Espa√±a (2018)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_2018.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2018.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_2018.update_layout(legend_title='A√±o')

fig_boxplot_2018 = px.box(df_energy_2018, y='price actual',
              title='Boxplot de Precio de Energ√≠a El√©ctrica - Espa√±a (2018)',
              labels={'price actual': 'Precio de Energ√≠a El√©ctrica [‚Ç¨/MWh]'},
              color_discrete_sequence=['teal'])
fig_boxplot_2018.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2018.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_boxplot_2018.update_layout(legend_title='A√±o')

fig_2018.show()
fig_boxplot_2018.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- Precio - A√±o 2015: Ha alcanzado con poca frecuencia valores muy bajos (cercanos a los 20 ‚Ç¨/MWh) y valores muy elevados (cercanos a los 100 ‚Ç¨/MWh).
        </p>
        üí°- Precio - A√±o 2016: Ha alcanzado valores m√°s bajos que el a√±o anterior, llegando incluso a valores de 10 ‚Ç¨/MWh.
        </p>
        üí°- Precio - A√±o 2017: Ha mantenido elevados en reiteradas ocasiones, llegando a los mencionados 100 ‚Ç¨/MWh. Se trata de un a√±o marcado por la subida del precio de la energ√≠a el√©ctrica.
        </p>
        üí°- Precio - A√±o 2018: Ha alcanzado, tambi√©n con mucha menos frecuencia, valores muy bajos (del orden de los 10 ‚Ç¨/MWh). Sin embargo, esta distribuci√≥n es la que m√°s desplazada hacia la derecha se encuentra.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 9. Valores at√≠picos de las variables climatol√≥gicas. ¬øQu√© comportamientos presentan las variables, analizando sus valores at√≠picos? ¬øQu√© toma de decisi√≥n se puede realizar con el an√°lisis?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se utilizar√°n gr√°ficos del tipo boxplot, los cuales ayudan a entender el comportamiento de las variables climatol√≥gicas.
        </p>
        Se hace √©nfasis en valores que afectan al an√°lisis. Esto se puede llevar por el camino de hacer una revisi√≥n de los eventos hist√≥ricos -del tipo clim√°ticos- en el pa√≠s.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Variable presi√≥n
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se consulta en un boxplot la informaci√≥n proporcionada por los datos:
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- Teniendo en cuenta que el valor m√°ximo de presi√≥n registrado en Espa√±a es de 1051 HPa <a href="https://en.wikipedia.org/wiki/List_of_atmospheric_pressure_records_in_Europe#Iberia" target="_blank">(seg√∫n fuente)</a>, todo valor superior a ese mismo, ser√° considerado un outlier. An√°logo a esto, valores menores a 950 ser√°n considerados tambi√©n outliers, debido a que el valor m√≠nimo de presi√≥n registrado en el pa√≠s fue de dicho valor.
        </p>
        üí°- Se tratar√°n a estos valores de forma tal que queden transformados en valores NaN.
        </p>
        üí°- Posteriormente, se utilizar√° el metodo de interpolaci√≥n lineal para transformarlos nuevamente en valores num√©ricos y √∫tiles en el an√°lisis.
"""

sns.set(style='white', font_scale=1.2)
plt.figure(figsize=(14, 6))
sns.boxplot(x=df_weather['pressure'], color='#DEB887')
plt.xlabel('Valores de presi√≥n atmosf√©rica [HPa]', fontsize=12)
plt.title('Boxplot de valores de presi√≥n atmosf√©rica [HPa] - Espa√±a 2015-2018')

plt.show()

"""- Reemplazo de valores outliers por valores NaN"""

df_weather.loc[df_weather.pressure > 1051, 'pressure'] = np.nan
df_weather.loc[df_weather.pressure < 950, 'pressure'] = np.nan

"""- Chequeo - Outliers 'pressure'"""

sns.set(style='white', font_scale=1.2)
plt.figure(figsize=(14, 6))
sns.boxplot(x=df_weather['pressure'], color='#DEB887')
plt.xlabel('Valores de presi√≥n atmosf√©rica [HPa]', fontsize=12)
plt.title('Boxplot de valores de presi√≥n atmosf√©rica [HPa] - Espa√±a 2015-2018')

plt.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Variable velocidad de viento
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se consulta en un boxplot la informaci√≥n proporcionada por los datos:
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- Se considera que todos los valores superiores a 50 m/s ser√°n tratados como valores outliers. Para la escala de Fujita, entrar√≠an en el rango F1 <a href=https://en.wikipedia.org/wiki/List_of_atmospheric_pressure_records_in_Europe#Iberia target="_blank">(seg√∫n fuente)</a>. Esto, indica que los valores analizados a√∫n ser√≠an tomados como eventos asociados a da√±os moderados, y que casi entrar√≠an en da√±os considerables (casi entrando al rango F2). Por ende, se asocia a estos valores una atipicidad tal de poder eliminarlos con seguridad.
        </p>
        üí°- Se tratar√°n a estos valores de forma tal que queden transformados en valores NaN.
        </p>
        üí°- Posteriormente, se utilizar√° el metodo de interpolaci√≥n lineal para transformarlos nuevamente en valores num√©ricos y √∫tiles en el an√°lisis.
"""

plt.figure(figsize=(14, 6))
sns.set(style='white', font_scale=1.2)
sns.boxplot(x=df_weather['wind_speed'], color='#DEB887')
plt.xlabel('Valores de velocidad de viento [m/s]', fontsize=12)
plt.title('Boxplot de valores de velocidad de viento [m/s] - Espa√±a 2015-2018')

plt.show()

"""- Reemplazo de valores outliers por valores NaN"""

df_weather.loc[df_weather.wind_speed > 50, 'wind_speed'] = np.nan

"""- Chequeo - Outliers 'wind_speed'"""

plt.figure(figsize=(14, 6))
sns.set(style='white', font_scale=1.2)
sns.boxplot(x=df_weather['wind_speed'], color='#DEB887')
plt.xlabel('Valores de velocidad de viento [m/s]', fontsize=12)
plt.title('Boxplot de valores de velocidad de viento [m/s] - Espa√±a 2015-2018')

plt.show()

"""- Visualizaci√≥n de los valores NaN en el dataframe (considerando variables presi√≥n y velocidad de viento)"""

df_weather[df_weather.isnull().any(axis=1)]
df_weather

"""- Relleno valores NaN empleando la interpolaci√≥n lineal mencionada.
    - La direcci√≥n es "hacia abajo" en el dataframe
"""

df_weather.interpolate(method='linear', limit_direction='forward', inplace=True, axis=0)

"""- Chequeo por los valores NaNs en df_weather (luego de tratar outliers)"""

conteo_missing_2 = df_weather.isnull().sum().sum()
print(f'Existen {conteo_missing_2} valores NaN en df_weather, luego de aplicar el tratamiento de outliers.')

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Variable lluvia
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se consulta en un gr√°fico de l√≠nea la informaci√≥n proporcionada por los datos:
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Teniendo en cuenta que los valores de 'rain_3h' deber√≠an ser mayores que los de la variable 'rain_1h', se grafican los datos a lo largo del per√≠odo 2015-2018.
        <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- Se eliminar√° a la variable 'rain_3h' en caso de que los valores de lluvia en las √∫ltimas 3 horas sean menores que los de la √∫ltima hora, cuesti√≥n que ocurre cuando se presenta el siguiente gr√°fico.
"""

sns.set(style='white', font_scale=1.2)

rain_features = ['rain_1h', 'rain_3h']

plt.figure(figsize=(18, 12))
plt.plot(df_weather['rain_1h'], label='Rain 1h', marker='o', color='#DEB887')
plt.plot(df_weather['rain_3h'], label='Rain 3h', marker='.', color='navy')
plt.xlabel('Tiempo de muestra')
plt.ylabel('Cantidad de lluvia (mm)')
plt.title('Gr√°fico de l√≠neas - Comparativa "rain 1h" vs "rain 3h"')
plt.legend(title='Valores de lluvia', title_fontsize=10, fontsize=10, loc='upper right')

plt.show()

"""- Elimincai√≥n de la columna 'rain_3h'"""

df_weather = df_weather.drop(['rain_3h'], axis=1)

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Variable de temperatura
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se har√° la conversi√≥n de los valores de temperatura para las columnas 'temp', 'temp_max', y 'temp_min' de grados Kelvin a grados Celsius - El m√©todo que se utiliza es con definici√≥n de una funci√≥n y luego aplicando "apply".
         <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Luego, se proceden a eliminar las columnas de temperaturas con valores en grados Kelvin.
         <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- La relaci√≥n matem√°tica empleada para hacer la conversi√≥n de unidad de temperatura es la siguiente: t(¬∞C)= T(K)-273,15

- Funci√≥n para conversi√≥n de temperatura
"""

def kelvin_to_celsius(temp_kelvin):
    return temp_kelvin - 273.15

df_weather['temp_c'] = df_weather['temp'].apply(kelvin_to_celsius)
df_weather['temp_max_c'] = df_weather['temp_max'].apply(kelvin_to_celsius)
df_weather['temp_min_c'] = df_weather['temp_min'].apply(kelvin_to_celsius)

"""- Eliminaci√≥n de las columnas originales (usadas en grados Kelvin)"""

df_weather = df_weather.drop(['temp', 'temp_max', 'temp_min'], axis=1)

"""- Chequeo final de variables con el m√©todo ".describe"
"""

df_weather.describe()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 10. Generaci√≥n energ√©tica. ¬øCu√°l es el aporte absoluto de cada fuente de energ√≠a (renovable o convencional) a su generaci√≥n total? ¬øQu√© comportamiento exhibe cada fuente?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Un gr√°fico de barras para la generaci√≥n el√©ctrica, seg√∫n el tipo de fuente empleada y para cada a√±o, resulta una buena idea para contestar el interrogante.
        </p>
        Se buscar√° hallar un comportamiento particular, para cada tipo de generaci√≥n, en materia de su aporte global, para el plazo de un a√±o.

- Gr√°fico interactivo para evaluar el aporte anual de cada tipo de generaci√≥n - bar chart -
- Empleo del m√©todo "groupby" para hacer la sumatoria de cada variable en todo el per√≠odo temporal
"""

pio.templates.default = "ggplot2"

columnas= ['generation fossil gas', 'generation fossil hard coal', 'generation fossil brown coal/lignite', 'generation fossil oil', 'generation nuclear',
           'generation hydro water reservoir', 'generation hydro pumped storage consumption', 'generation hydro run-of-river and poundage', 'generation biomass', 'generation wind onshore', 'generation solar']

df_energy_2015_2018 = df_energy[(df_energy.index.year >= 2015) & (df_energy.index.year <= 2018)]
df_energy_2015_2018_sum = df_energy_2015_2018.groupby(df_energy_2015_2018.index.year)[columnas].sum()

palette = ['#929591', '#D1B26F', '#653700', '#FBDD7E', '#15B01A', '#4C78A8', '#0099C6', '#19D3F3', '#006400', '#069AF3', '#FFA500']

fig = px.bar(df_energy_2015_2018_sum, x=df_energy_2015_2018_sum.index, y=columnas, color_discrete_sequence=palette,
             title='Generaci√≥n energ√©tica por tipo de fuente de energ√≠a - Espa√±a (2015-2018)',
             labels={'value': 'Generaci√≥n energ√©tica [MW]', 'variable': 'Tipo de energ√≠a seg√∫n fuente empleada'},
             category_orders={"index": [str(year) for year in df_energy_2015_2018_sum.index]})
fig.update_xaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_xaxes(categoryorder='array')
fig.update_xaxes(dtick=1)
fig.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
         <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        üí°- La generaci√≥n e√≥lica encabeza la mayor aportante en cuanto a energ√≠a generada, seguida por la hidroel√©ctrica, la solar y las derivadas de la biomasa.
        </p>
        üí°- El aporte de las renovables durante todos los a√±os evaluados es similar.
        </p>
        üí°- La energ√≠a nuclear est√° muy presente en el aporte de generaci√≥n a la matriz energ√©tica, y tambi√©n presenta un comportamiento id√©ntico en cada per√≠odo.
        </p>
        üí°- Las energ√≠as convencionales presentan una flexibilidad m√°s visible en materia de generaci√≥n, debido a que "cubren" la cantidad demandada que no pueden abastecer las renovables o la nuclear.
        </p>
        üí°- No se incluyen otras formas de generaci√≥n de energ√≠a (fuente de residuos y otras renovables) porque aportan poco al an√°lisis para responder √©ste interrogante.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 11. Generaci√≥n energ√©tica. ¬øC√≥mo se da la evoluci√≥n en el aporte de cada fuente de generaci√≥n energ√©tica en un per√≠odo anual? ¬øY c√≥mo se da la evoluci√≥n en el aporte de cada fuente de generaci√≥n energ√©tica en un per√≠odo diario? ¬øQu√© relaci√≥n se puede obtener si se incluye la variable precio a estas visualizaciones?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se utilizan gr√°ficos de l√≠neas para visualizar la serie temporal y el comportamiento de las renovables, convencionales y la variable precio en conjunto.
        </p>
        Se podr√° obtener la pauta sobre los per√≠odos del a√±o en donde es m√°s frecuente encontrar una mayor o menor cantidad de energ√≠a producida desde las fuentes renovables (el ejemplo cl√°sico es el de la solar: durante las estaciones de verano produce mucho m√°s). √çdem que en el caso anterior, pero para el caso de las convencionales, se deber√° buscar en qu√© momento se halla una relaci√≥n fuerte entre generaci√≥n convencional y per√≠odo estacional.
        </p>
        Incluyendo a la variable precio dentro del an√°lisis de generaci√≥n energ√©tica, lograr√° identificar c√≥mo se comporta la variable target en el plazo de tiempo diario. Valores del precio elevados, o, en su defecto, bajos, deber√°n ser relacionados en base a la generaci√≥n existente, e identificar c√≥mo se da el mix energ√©tico entre cada tipo de producci√≥n.

- Gr√°fico interactivo para evaluar la evoluci√≥n anual de cada tipo de generaci√≥n - line chart -
"""

pio.templates.default = "ggplot2"

df_energy_2015_2018 = df_energy[(df_energy.index.year >= 2015) & (df_energy.index.year <= 2018)]

columnas_convencionales = ['generation fossil gas', 'generation fossil hard coal', 'generation fossil brown coal/lignite', 'generation fossil oil', 'generation nuclear']
columnas_renovables = ['generation hydro water reservoir', 'generation hydro pumped storage consumption', 'generation hydro run-of-river and poundage', 'generation biomass', 'generation wind onshore', 'generation solar']

colors = ['#929591', '#D1B26F', '#653700', '#FBDD7E', '#15B01A', '#4C78A8', '#0099C6', '#19D3F3', '#006400', '#069AF3', '#FFA500']

fig_energia = go.Figure()

for i, columna in enumerate(columnas_convencionales + columnas_renovables):
    fig_energia.add_trace(go.Scatter(x=df_energy_2015_2018.index, y=df_energy_2015_2018[columna], mode='lines', name=columna, line=dict(color=colors[i])))

fig_energia.add_trace(go.Scatter(x=df_energy_2015_2018.index, y=df_energy_2015_2018['price actual'], mode='lines', name='Precio [‚Ç¨/MWh]', yaxis='y2', line=dict(color='black')))
fig_energia.update_layout(
    title='Generaci√≥n de Energ√≠a y Precio - Espa√±a (2015-2018)',
    xaxis_title='Per√≠odo Temporal',
    yaxis_title='Generaci√≥n de Energ√≠a [MW]',
    yaxis2=dict(title='Precio [‚Ç¨/MWh]', overlaying='y', side='right'),
)
fig_energia.update_layout(showlegend=True, legend=dict(x=1.05, y=-0.32))
fig_energia.update_xaxes(
    showline=True, linewidth=3, linecolor='black', mirror=True,
    rangeslider_visible=True,
    rangeselector=dict(
        buttons=list([
            dict(count=1, label="1 d√≠a", step="day", stepmode="backward"),
            dict(count=1, label="1 mes", step="month", stepmode="backward"),
            dict(count=6, label="6 meses", step="month", stepmode="backward"),
            dict(count=1, label="1 a√±o", step="year", stepmode="backward"),
            dict(label="Todos los registros", step="all")
        ])
    )
)
fig_energia.update_yaxes(showline=True, linewidth=3, linecolor='black', mirror=True)
fig_energia.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Para un per√≠odo anual:
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- Sector de la energ√≠a nuclear: presenta un comportamiento constante y tiene gran participaci√≥n en la matriz de generaci√≥n el√©ctrica.
          </p>
          üí°- La misma situaci√≥n ocurre con el del gas natural. La tecnolog√≠a que admite esta producci√≥n se asienta muy bien para abastecer cualquier imprevisto en la modificaci√≥n de la demanda. Una forma clara de visualizar esto, es que este tipo de generaci√≥n siempre alcanza el piso de los 5000 MW abastecidos.
          </p>
          üí°- El sector del carb√≥n no presenta un comportamiento muy regular, como s√≠ ocurre en los dos casos anteriores. Particularmente, el carb√≥n marr√≥n casi que no tiene participaci√≥n a escala anual, comparada con las dem√°s fuentes de energ√≠a.
          </p>
          üí°- Para el sector de las energ√≠as renovables, se puede observar una mayor participaci√≥n en la estaci√≥n de verano para la energ√≠a solar, debido a que las condiciones de temperatura y nubosidad son √≥ptimas. Estas condiciones son √≥ptimas para que las tecnolog√≠as que se utilizan demuestren todo su potencial.
          </p>
          üí°- Siguiendo con las renovables, se puede observar una gran participaci√≥n de la energ√≠a e√≥lica a lo largo del a√±o, seguida por la hidroel√©ctrica, y en mucha menor medida por la biomasa. La alta generaci√≥n provocada por la e√≥lica, en per√≠odos que no forman parte del verano (ej. enero hasta marzo), tienen que ver con las condiciones clim√°ticas que garantizan buenas velocidades del viento. De igual manera, un adecuado nivel de precipitaciones garantiza una mayor producci√≥n para el sector hidroel√©ctrico.
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Para un per√≠odo diario, se toman dos d√≠as aleatorios -uno de primavera (17/11/2018) y otro de verano (25/07/2018)-:
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- La energ√≠a solar es predominante durante las horas de sol, esto es, entre las 08:00 y 16:00 hs.
          </p>
          üí°- La energ√≠a nuclear aporta una elevada generaci√≥n de forma constante (plena potencia), y puede vender toda la energ√≠a producida al mercado.
          </p>
          üí°- La energ√≠a e√≥lica, al igual que la nuclear, presenta una importante relevancia en este mercado dentro de todos los tramos horarios. Al igual que la nuclear y la solar, vende toda la energ√≠a producida. Pero hay que tener en cuenta que depende fuertemente de las condiciones clim√°ticas.
          </p>
          üí°- Es importante mencionar que, para las hidroel√©tricas fluyentes, su aporte de generaci√≥n depende del caudal de los r√≠os (dependientes de las precipitaciones y niveles de agua). Para las dem√°s hidroel√©ctricas (bombeo y reservorio), no se presenta este problema con frecuencia, debido a que su sistema de producci√≥n logra una gesti√≥n m√°s eficiente de sus recursos (no es tan intermitente como la otra).
          </p>
          üí°- La energ√≠a producida por, principalmente, gas natural, carb√≥n y fueloil, son de gran importancia en el mercado. Cuando no hay producci√≥n de energ√≠a solar (ausencia de radiaci√≥n proveniente del sol), estas tecnolog√≠as asisten a la generaci√≥n energ√©tica. Las tecnolog√≠as que utilizan gas natural, se asientan de muy buena forma en el sector de la generaci√≥n, como se coment√≥.
          </p>
          üí°- Al tenerse en cuenta el d√≠a de verano, la tecnolog√≠as que utilizan la energ√≠a solar incluyen sistemas de almacenamiento de energ√≠a para maximizar su producci√≥n durante los per√≠odos en ausencia de luz solar (cuesti√≥n que, generalmente, no ocurre durante las otras estaciones del a√±o, por cuestiones de costos). Por ende, durante el verano, la energ√≠a solar explota todo su potencial.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Para completar el an√°lisis, se presentan dos tablas que muestran las variables estudiadas y su comportamiento.

- Creaci√≥n de una tabla para d√≠a de primavera - aleatorio -, visualizando:
    - Variable precio
    - Promedio del precio en ese d√≠a
    - Generaci√≥n renovable, en MW
    - Generaci√≥n convencional, en MW
    - Generaci√≥n total, en MW
    - Generaci√≥n en ese d√≠a, en MW

- Creaci√≥n de una tabla para d√≠a de verano - aleatorio -, visualizando:
    - Variable precio
    - Promedio del precio en ese d√≠a
    - Generaci√≥n renovable, en MW
    - Generaci√≥n convencional, en MW
    - Generaci√≥n total, en MW
    - Generaci√≥n en ese d√≠a, en MW
"""

day = df_energy.loc['2018-11-17']

hourly_data_1 = pd.DataFrame(index=day.index)

hourly_data_1['Precio [‚Ç¨/MWh]'] = day['price actual'].round(1)
hourly_data_1['Promedio precio [‚Ç¨/MWh]'] = day['price actual'].mean().round(1)
hourly_data_1['Generaci√≥n renovable [MW]'] = day[columnas_renovables].sum(axis=1)
hourly_data_1['Generaci√≥n convencional [MW]'] = day[columnas_convencionales].sum(axis=1)
hourly_data_1['Generaci√≥n total [MW]'] = hourly_data_1['Generaci√≥n renovable [MW]'] + hourly_data_1['Generaci√≥n convencional [MW]']
hourly_data_1['Sumatoria total [MW]'] = hourly_data_1['Generaci√≥n total [MW]'].sum()

hourly_data_1

summer_day = df_energy.loc['2018-07-25']

hourly_data_2 = pd.DataFrame(index=summer_day.index)

hourly_data_2['Precio [‚Ç¨/MWh]'] = summer_day['price actual'].round(1)
hourly_data_2['Promedio precio [‚Ç¨/MWh]'] = summer_day['price actual'].mean().round(1)
hourly_data_2['Generaci√≥n renovable [MW]'] = summer_day[columnas_renovables].sum(axis=1)
hourly_data_2['Generaci√≥n convencional [MW]'] = summer_day[columnas_convencionales].sum(axis=1)
hourly_data_2['Generaci√≥n total [MW]'] = hourly_data_2['Generaci√≥n renovable [MW]'] + hourly_data_2['Generaci√≥n convencional [MW]']
hourly_data_2['Sumatoria total [MW]'] = hourly_data_2['Generaci√≥n total [MW]'].sum()

hourly_data_2

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- Tanto el precio como la demanda, del d√≠a de verano (25/07) son mayores que los del d√≠a aleatorio considerado (17/11).
          </p>
          üí°- Durante el verano, a pesar de que la generaci√≥n por energ√≠a solar es mayor, la demanda tambi√©n crece en n√∫mero. Esto, admite que otras fuentes de generaci√≥n (como las que emplean combustibles f√≥siles) puedan participar y encarecer el precio.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 12. Proporci√≥n en la generaci√≥n: ¬øCu√°l es la proporci√≥n porcentual de generaci√≥n de energ√≠a proveniente tanto de fuentes renovables como de fuentes convencionales?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se utilizan gr√°ficos piechart para visualizar el balance del "mix" energ√©tico, entre renovables y convencionales.

- Gr√°fico interactivo para visualizar el reparto o "mix" de generaci√≥n el√©ctrica convencional - piechart -
    - Se realiza para ambos grupos de variables
"""

pio.templates.default = "ggplot2"

def piechart_convencionales(yr):

    df_energy_piechart_c = df_energy[df_energy.index.year == yr]
    generacion_convencional = df_energy_piechart_c[columnas_convencionales].sum().sum()
    data_convencionales = {
        'Fuente de Energ√≠a Convencional': columnas_convencionales,
        'Generaci√≥n de Energ√≠a (MW)': [df_energy_piechart_c[col].sum() for col in columnas_convencionales]
    }
    df_pie_convencionales = pd.DataFrame(data_convencionales)

    colors_convencionales = ['#929591', '#15B01A', '#D1B26F', '#653700', '#FBDD7E']

    fig_convencionales = px.pie(
        df_pie_convencionales,
        names='Fuente de Energ√≠a Convencional',
        values='Generaci√≥n de Energ√≠a (MW)',
        title='Proporci√≥n de generaci√≥n de energ√≠a por fuentes convencionales - Espa√±a {}'.format(yr),
        color_discrete_sequence=colors_convencionales,
        hover_data=['Generaci√≥n de Energ√≠a (MW)'],
        width=2000,
        height=600
    )
    fig_convencionales.update_layout(
        title={
            'x': 0.5,
            'y': 0.9,
            'font': {
                'size': 24
            }
        },
        legend={
            'x': 0.95,
            'y': 0.1
        })
    fig_convencionales.update_traces(textfont_size=20,
                                  marker=dict(line=dict(color='black', width=3)))
    return fig_convencionales

piechart_2015_c = piechart_convencionales(2015)
piechart_2016_c = piechart_convencionales(2016)
piechart_2017_c = piechart_convencionales(2017)
piechart_2018_c = piechart_convencionales(2018)

piechart_2015_c.show()
piechart_2016_c.show()
piechart_2017_c.show()
piechart_2018_c.show()

pio.templates.default = "ggplot2"

def piechart_renovables(yr):

    df_energy_piechart_r = df_energy[df_energy.index.year == yr]
    generacion_renovable = df_energy_piechart_r[columnas_renovables].sum().sum()
    data_renovables = {
        'Fuente de Energ√≠a Renovable': columnas_renovables,
        'Generaci√≥n de Energ√≠a (MW)': [df_energy_piechart_r[col].sum() for col in columnas_renovables]
    }
    df_pie_renovables = pd.DataFrame(data_renovables)

    colors_renovables = ['#069AF3', '#0099C6', '#FFA500', '#19D3F3', '#4C78A8', '#006400']

    fig_renovables = px.pie(
        df_pie_renovables,
        names='Fuente de Energ√≠a Renovable',
        values='Generaci√≥n de Energ√≠a (MW)',
        title='Proporci√≥n de generaci√≥n de energ√≠a por fuentes renovables - Espa√±a {}'.format(yr),
        color_discrete_sequence=colors_renovables,
        hover_data=['Generaci√≥n de Energ√≠a (MW)'],
        width=2000,
        height=600
    )
    fig_renovables.update_layout(
        title={
            'x': 0.5,
            'y': 0.9,
            'font': {
                'size': 24
            }
        },
        legend={
            'x': 0.95,
            'y': 0.1
        })
    fig_renovables.update_traces(textfont_size=20,
                                  marker=dict(line=dict(color='black', width=3)))
    return fig_renovables

piechart_2015_r = piechart_renovables(2015)
piechart_2016_r = piechart_renovables(2016)
piechart_2017_r = piechart_renovables(2017)
piechart_2018_r = piechart_renovables(2018)

piechart_2015_r.show()
piechart_2016_r.show()
piechart_2017_r.show()
piechart_2018_r.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- La generaci√≥n por energ√≠a e√≥lica e hidroel√©ctrica sostienen un gran ritmo de producci√≥n energ√©tica del tipo renovable (casi 50%  y aproximado del 35% respectivamente), mientras que la solar apenas aporta un 12,5%. La biomasa aporta muy poco a la matriz energ√©tica.
          </p>
          üí°- La generaci√≥n nuclear, por su parte, compite con la del gas natural, llegando a ocupar el 70% de la generaci√≥n por convencionales. Le sigue el carb√≥n duro con un 25%, y el resto de las tecnolog√≠as apenas aportan un 4%.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 13. Valores at√≠picos de la variable precio. ¬øQu√© an√°lisis se puede realizar teniendo en cuenta los valores outliers?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Mediante una tabla, se analiza el efecto que tienen los outliers en la target feature. Se adjuntan los valores de generaci√≥n energ√©tica, sea del tipo renovable o convencional.

- Se crea una funci√≥n para obtener los outliers en un dataframe (para todos los a√±os del per√≠odo evaluado, discriminados)
    - Los l√≠mites inferior y superior ser√°n calculados conociendo el IQR y los valores de Q1 y Q3, para la variable target.
- Por √∫ltimo, se calculan:
    - Energ√≠a generada por fuente renovable
    - Energ√≠a generada por fuente convencional
    - Total de energ√≠a generada
    - Porcentaje de energ√≠a renovable y convencional
"""

def get_outliers(df):
    Q1 = df['price actual'].quantile(0.25)
    Q3 = df['price actual'].quantile(0.75)
    IQR = Q3 - Q1
    lim_inf = Q1 - 1.5 * IQR
    lim_sup = Q3 + 1.5 * IQR
    outliers = df[(df['price actual'] < lim_inf) | (df['price actual'] > lim_sup)]
    return outliers

outliers_15 = get_outliers(df_energy_2015)
outliers_16 = get_outliers(df_energy_2016)
outliers_17 = get_outliers(df_energy_2017)
outliers_18 = get_outliers(df_energy_2018)

outliers_df = pd.concat([outliers_15, outliers_16, outliers_17, outliers_18], ignore_index=True)

renovable_columns = ['generation hydro water reservoir', 'generation hydro pumped storage consumption', 'generation hydro run-of-river and poundage', 'generation solar', 'generation wind onshore', 'generation biomass', 'generation waste', 'generation other renewable']
outliers_df['Energ√≠a renovable [MW]'] = outliers_df[renovable_columns].sum(axis=1)

convencional_columns = ['generation fossil gas', 'generation fossil hard coal', 'generation fossil oil', 'generation fossil brown coal/lignite', 'generation nuclear']
outliers_df['Energ√≠a convencional [MW]'] = outliers_df[convencional_columns].sum(axis=1)

outliers_df['Total generaci√≥n [MW]'] = outliers_df['Energ√≠a renovable [MW]'] + outliers_df['Energ√≠a convencional [MW]']

outliers_df['Porcentaje renovable (%)'] = (outliers_df['Energ√≠a renovable [MW]'] / outliers_df['Total generaci√≥n [MW]']).round(2) * 100

outliers_df['Porcentaje convencional (%)'] = (outliers_df['Energ√≠a convencional [MW]'] / outliers_df['Total generaci√≥n [MW]']).round(2) * 100

outliers_df[['price actual', 'Energ√≠a renovable [MW]', 'Energ√≠a convencional [MW]',
                   'Porcentaje renovable (%)', 'Porcentaje convencional (%)', 'Total generaci√≥n [MW]']]

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- Se observa que un precio elevado, deber√≠a corresponder a per√≠odos en los que la generaci√≥n por el uso de combustibles f√≥siles sea mayor a las fuentes renovables.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 14. Impacto ambiental. ¬øExiste alguna correlaci√≥n entre la generaci√≥n de energ√≠a a partir de fuentes f√≥siles y las emisiones de gases de efecto invernadero u otros impactos ambientales?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        No se cuentan con datos que marquen cuantitativamente las emisiones asociadas al proceso de generaci√≥n el√©ctrica, seg√∫n cada fuente empleada.
        </p>
        Sin embargo, para futuras entregas, se pueden emplear relaciones matem√°ticas sencillas para calcular estas emisiones, s√≥lamente conociendo la energ√≠a generada.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 15. Potencia instalada en el sector de generaci√≥n energ√©tica. ¬øC√≥mo se distribuye la cantidad de potencia instalada para las diversas tecnolog√≠as de producci√≥n de energ√≠a el√©ctrica?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        No se dispone de tal informaci√≥n en este dataset, pero se puede consultar a fuentes oficiales del sector energ√©tico espa√±ol.

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 2px solid #f8f8f8; font-size: 20px; font-family: 'Lexend', sans-serif; color: black; text-align: left; background-color: #f5d769; padding: 1px; border-radius: 5px;">
          ‚ö° Interrogante 16. Generaci√≥n de energ√≠a por ubicaci√≥n geogr√°fica. Si el conjunto de datos incluye informaci√≥n sobre la ubicaci√≥n de las plantas de generaci√≥n de energ√≠a, ¬øc√≥mo var√≠a la generaci√≥n de energ√≠a en diferentes regiones geogr√°ficas?

<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Para responder a este interrogante, se debe hacer uso del 2¬∞ Dataset - Data Enrichment -, que incluye variables climatol√≥gicas para 5 de las m√°s importantes ciudades en el pa√≠s (Madrid, Barcelona, Valencia, Sevilla y Bilbao). Con ello, se realiza un an√°lisis multivariado y se procede a concluir el EDA.

- A partir de ahora, para enriquecer las visulizaciones, se combinar√°n ambos archivos en uno solo
    - Inicialmente, se divide el dataframe 'df_weather' en 5 dataframes (uno por cada ciudad)
    - Se combinan todos los dataframes en uno final (df_final)
"""

df_1, df_2, df_3, df_4, df_5 = [x for _, x in df_weather.groupby('city_name')]
dfs = [df_1, df_2, df_3, df_4, df_5]

df_final = df_energy

for df in dfs:
    city = df['city_name'].unique()
    city_str = str(city).replace("'", "").replace('[', '').replace(']', '').replace(' ', '')
    df = df.add_suffix('_{}'.format(city_str))
    df_final = df_final.merge(df, on=['time'], how='outer')
    df_final = df_final.drop('city_name_{}'.format(city_str), axis=1)

df_final.columns

"""- Se hace un chequeo de los registros con ".info" y luego se hace lo mismo pero con ".describe"
"""

df_final.info()

df_final.describe()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se realiza una visualizaci√≥n con un mapa de calor, para identificar r√°pidamente las variables mayormente correlacionadas con la variable target, debido a que se a√±adieron muchas variables.
        </p>
        Se har√° hincapi√© en las variables de temperatura y velocidad de viento, debido a que son algunas de las que m√°s influyen en el precio de la electricidad (seg√∫n bibliograf√≠as consultadas).

- Empleo de la matriz de correlaci√≥n - tipo heatmap -
"""

from bokeh.palettes import Spectral6
from bokeh.io import show, output_notebook
from bokeh.models import HoverTool, CategoricalColorMapper, ColumnDataSource, FactorRange
from bokeh.plotting import figure, output_file, show
import warnings
warnings.filterwarnings("ignore", category=UserWarning)
from bokeh.plotting import figure

correlaciones_final = df_final.corr(method='pearson')
filas = correlaciones_final.index.tolist()
columnas = correlaciones_final.columns.tolist()

correlaciones_f = []
for i, fila in enumerate(filas):
    for j, columna in enumerate(columnas):
        correlacion_f = correlaciones_final.iloc[i, j]
        correlacion_f = correlacion_f.item()
        correlaciones_f.append((fila, columna, correlacion_f))

data = {'filas': [x[0] for x in correlaciones_f], 'columnas': [x[1] for x in correlaciones_f], 'correlaciones': [x[2] for x in correlaciones_f]}
source = ColumnDataSource(data)
mapper = linear_cmap(field_name='correlaciones', palette=Viridis256, low=-1, high=1)

p = figure(x_range=filas, y_range=columnas, width=2000, height=1600, tooltips=[('Filas', '@filas'), ('Columnas', '@columnas'), ('Correlaci√≥n', '@correlaciones{0.00}')])
p.rect(x='filas', y='columnas', width=1, height=1, source=source,
       line_color='white', fill_color=mapper)
p.xaxis.major_label_orientation = 3.14 / 4
p.title.text = 'Matriz de Correlaciones - M√©todo Pearson'
color_bar = ColorBar(color_mapper=mapper['transform'], width=8, location=(0, 0))
p.add_layout(color_bar, 'right')
p.add_tools(HoverTool())

output_file("multivariado.html")

output_notebook()
show(p)

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se establece una relaci√≥n entre la variable de temperatura para cada ciudad y la demanda de energ√≠a el√©ctrica. Esto se lleva a cabo con un gr√°fico de serie temporal, sumado a un gr√°fico de dispersi√≥n para evaluar el recurso clim√°tico (solar) frente a la variable de generaci√≥n (solar), para la Ciudad de Sevilla.

- Gr√°fico interactivo entre temperatura para cada ciudad y demanda de energ√≠a - lineplot -
"""

pio.templates.default = "ggplot2"

df_filtered = df_final.loc['2015':'2018']
ciudades = ['Barcelona', 'Madrid', 'Seville', 'Bilbao', 'Valencia']


df_melted = pd.melt(df_filtered.reset_index(), id_vars=['time'], value_vars=[f'temp_c_{city}' for city in ciudades], var_name='Ciudad', value_name='Temperatura')
df_melted['ma7_temp'] = df_melted.groupby('Ciudad')['Temperatura'].transform(lambda x: x.rolling(window=7).mean())


fig = go.Figure()

for city in ciudades:
    city_data = df_melted[df_melted['Ciudad'] == f'temp_c_{city}']
    fig.add_trace(go.Scatter(x=city_data['time'], y=city_data['Temperatura'], mode='lines', name=f'Temperatura (¬∞C) - {city}'))
    fig.add_trace(go.Scatter(x=city_data['time'], y=city_data['ma7_temp'], mode='lines', name=f'Media M√≥vil 7 d√≠as (¬∞C) - {city}'))

fig.add_trace(go.Scatter(x=df_filtered.index, y=df_filtered['total load actual'], mode='lines', name='Demanda energ√©tica actual [MW]', yaxis='y2', line=dict(color='#C79FEF')))

fig.update_layout(title='Temperatura en Ciudades (2015-2018) y Demanda de energ√≠a el√©ctrica',
                  xaxis_title='A√±o',
                  yaxis_title='Temperatura (¬∞C)',
                  yaxis2=dict(title='Demanda energ√©tica [MW]', overlaying='y', side='right'),
                  legend_title='Ciudad',
                  legend=dict(x=0, y=-0.15, orientation='h'))

fig.show()

"""- Gr√°fico interactivo entre generaci√≥n solar y temperatura diaria en Sevilla - scatterplot -"""

pio.templates.default = "ggplot2"

df_2015_2018_final = df_final[(df_final.index.year >= 2015) & (df_energy.index.year <= 2018)]

fig = px.scatter(df_2015_2018_final, x='temp_c_Seville', y='generation solar', color=df_2015_2018_final.index.year,
                 title='Generaci√≥n solar vs Temperatura en Sevilla - A√±os 2015-2018',
                 labels={'temp_c_Seville': 'Temperatura en Sevilla (¬∫C)', 'generation solar': 'Generaci√≥n solar en Espa√±a [MW]'},
                 trendline='ols')
fig.update_xaxes(title='Temperatura (¬∫C)', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(title='Generaci√≥n energ√©tica [MW]', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_traces(marker=dict(size=5))
fig.update_layout(
    coloraxis_colorbar=dict(
        title='A√±o',
        tickvals=[2015, 2016, 2017, 2018],
        ticktext=['2015', '2016', '2017', '2018']
    ))

fig.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se establece una relaci√≥n entre la variable de velocidad de viento para cada ciudad y las generaciones de energ√≠a e√≥lica m√°s el total de todo el pa√≠s. Esto se lleva a cabo con un gr√°fico de serie temporal, sumado a un gr√°fico de dispersi√≥n para evaluar el recurso clim√°tico (vel. de viento) frente a la variable de generaci√≥n (e√≥lica), para la Ciudad de Valencia.

- Gr√°fico interactivo entre generaci√≥n de energ√≠a e√≥lica, generaci√≥n total en el pa√≠s y velocidades de viento por ciudades - lineplot -
"""

pio.templates.default = "ggplot2"

fuentes_generaci√≥n = ['generation biomass', 'generation fossil brown coal/lignite',
                      'generation fossil gas', 'generation fossil hard coal',
                      'generation fossil oil', 'generation hydro pumped storage consumption',
                      'generation hydro run-of-river and poundage', 'generation hydro water reservoir',
                      'generation nuclear', 'generation other', 'generation other renewable',
                      'generation solar', 'generation waste', 'generation wind onshore']




fig = go.Figure()

for city in ciudades:
    fig.add_trace(go.Scatter(x=df_filtered.index, y=df_filtered[f'wind_speed_{city}'], mode='lines', name=f'Velocidad del Viento {city}'))

df_filtered['total_generation'] = df_filtered[fuentes_generaci√≥n].sum(axis=1)

fig.add_trace(go.Scatter(x=df_filtered.index, y=df_filtered['total_generation'], mode='lines', name='Generaci√≥n Total', yaxis='y2', line=dict(color='orange')))
fig.add_trace(go.Scatter(x=df_filtered.index, y=df_filtered['generation wind onshore'], mode='lines', name='Generaci√≥n E√≥lica', yaxis='y2', line=dict(color='#069AF3')))

fig.update_layout(title='Velocidad del Viento en Ciudades y Generaci√≥n El√©ctrica (e√≥lica/total) (2015-2018)',
                  xaxis_title='A√±o',
                  yaxis_title='Velocidad del Viento (m/s)',
                  yaxis2=dict(title='Generaci√≥n El√©ctrica (MW)', overlaying='y', side='right'),
                  legend_title='Ciudad',
                  legend=dict(x=0, y=-0.2, orientation='h'))

fig.show()

"""- Gr√°fico interactivo entre generaci√≥n e√≥lica y velocidad de viento en Valencia - scatterplot -"""

pio.templates.default = "ggplot2"

fig = px.scatter(df_2015_2018_final, x='wind_speed_Valencia', y='generation wind onshore', color=df_2015_2018_final.index.year,
                 title='Generaci√≥n e√≤lica vs Velocidad de viento en Valencia - A√±os 2015-2018',
                 labels={'wind_speed_Valencia': 'Velocidad de viento en Valencia (m/s)', 'generation wind onshore': 'Generaci√≥n e√≤lica en Espa√±a [MW]'},
                 trendline='ols')
fig.update_xaxes(title='Velocidad de viento (m/s)', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(title='Generaci√≥n energ√©tica [MW]', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_traces(marker=dict(size=5))
fig.update_layout(
    coloraxis_colorbar=dict(
        title='A√±o',
        tickvals=[2015, 2016, 2017, 2018],
        ticktext=['2015', '2016', '2017', '2018']
    ))

fig.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
        <h1 style="border: 1px solid #240b36; font-size: 16px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
        Se establece una relaci√≥n entre la variable de velocidad de lluvia y la generaci√≥n de energ√≠a el√©ctrica por gas natural. Esto se lleva a cabo con un gr√°fico de serie temporal, sumado a un gr√°fico de dispersi√≥n para evaluar el recurso clim√°tico (lluvia) frente a la variable de generaci√≥n (gas natural), para la Ciudad de Barcelona.

- Gr√°fico interactivo entre lluvias por ciudad y generaci√≥n por gas natural - lineplot -
"""

pio.templates.default = "ggplot2"

columnas_lluvia = ['rain_1h_Barcelona', 'rain_1h_Madrid', 'rain_1h_Seville', 'rain_1h_Valencia', 'rain_1h_Bilbao']
columna_gas = 'generation fossil gas'

df_lluvia = df_final.loc['2015':'2018', columnas_lluvia + [columna_gas]]

df_lluvia_reset = df_lluvia.reset_index()

df_melted_lluvia = pd.melt(df_lluvia_reset, id_vars=['time'], value_vars=columnas_lluvia + [columna_gas],
                           var_name='Variable', value_name='Valor')

fig = go.Figure()
for city in ciudades:
    fig.add_trace(go.Scatter(x=df_melted_lluvia[(df_melted_lluvia['Variable'] == f'rain_1h_{city}')]['time'],
                             y=df_melted_lluvia[(df_melted_lluvia['Variable'] == f'rain_1h_{city}')]['Valor'],
                             mode='lines', name=f'Lluvia {city}'))
fig.add_trace(go.Scatter(x=df_melted_lluvia[(df_melted_lluvia['Variable'] == columna_gas)]['time'],
                         y=df_melted_lluvia[(df_melted_lluvia['Variable'] == columna_gas)]['Valor'],
                         mode='lines', name='Generaci√≥n por Gas Natural', yaxis='y2', line=dict(color='#929591')))
fig.update_layout(title='Lluvia y Generaci√≥n por Gas Natural (2015-2018)',
                  xaxis_title='A√±o',
                  yaxis_title='Lluvia (mm)',
                  legend_title='Ciudad',
                  legend=dict(x=0, y=-0.2, orientation='h'),
                  yaxis2=dict(title='Generaci√≥n de Gas', overlaying='y', side='right'))

fig.show()

"""- Gr√°fico interactivo entre generaci√≥n hidroel√©ctrica (reservorio) y la cantidad de lluvia (mm en √∫ltima hora) en Barcelona - scatterplot -"""

pio.templates.default = "ggplot2"

fig = px.scatter(df_2015_2018_final, x='rain_1h_Barcelona', y='generation hydro water reservoir', color=df_2015_2018_final.index.year,
                 title='Generaci√≥n hidroel√©ctrica vs Registro de lluvias en Barcelona - A√±os 2015-2018',
                 labels={'rain_1h_Barcelona': 'Registro de lluvias en Barcelona (mm)', 'generation hydro water reservoir': 'Generaci√≥n hidroel√©ctrica -reservorio- en Espa√±a [MW]'},
                 trendline='ols')
fig.update_xaxes(title='Registro de lluvias (mm)', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_yaxes(title='Generaci√≥n hidroel√©ctrica -reservorio- [MW]', showline=True, linewidth=3, linecolor='black', mirror=True)
fig.update_traces(marker=dict(size=5))
fig.update_layout(
    coloraxis_colorbar=dict(
        title='A√±o',
        tickvals=[2015, 2016, 2017, 2018],
        ticktext=['2015', '2016', '2017', '2018']
    ))

fig.show()

"""<div style="width: 100%; text-align: center;">
  <div style="max-width: 800px; margin: 0 auto;">
      <div style="background-color: #DEB887; padding: 10px; border-radius: 5px;">
          <h1 style="border: 1px solid #240b36; font-size: 18px; font-family: 'Lexend', sans-serif; color: black; text-align: center; background-color: #dff4ff; padding: 10px; border-radius: 5px;">
          üí°- Como conclusi√≥n, entrando en instancias de decisi√≥n, lamentablemente, no se asegura ni siquiera una correlaci√≥n moderada entre la target y las variables clim√°ticas m√°s importantes -temperaturas, velocidades de viento y lluvias-.
          </p>
          üí°- Las variables de temperatura en las ciudades, rondan en un coeficiente de correlaci√≥n - Pearson - de 0.20 con respecto a la demanda. A modo de ejemplo, se tom√≥ la ciudad de Sevilla (Comunidad de Andaluc√≠a - con mejor recurso solar del pa√≠s -) y se tiene un coeficiente de correlaci√≥n de 0.40 entre la generaci√≥n solar y la temperatura diaria.
          </p>
          üí°- La variable de generaci√≥n e√≥lica -principal protagonista del mercado renovable- se correlaciona de forma moderada y negativa con respecto a las variables de generaci√≥n convencionales (principalmente las que emplean gas natural y carb√≥n). Esto tiene sentido ya que ante la falta de producci√≥n e√≥lica, los combustibles f√≥siles aportan en materia de producci√≥n, encareciendo el precio. A modo de ejemplo, se tom√≥ la ciudad de Valencia (Comunidad de Valencia -con un buen recurso e√≥lico y abundante producci√≥n el√©ctrica-e√≥lica) y se cuentan con d√©biles valores de correlaci√≥n.
          </p>
          üí°- La variable de generaci√≥n hidroel√©ctrica mediante reservorios no tiene una correlaci√≥n moderada con la variable de generaci√≥n convencional por gas natural. A modo de ejemplo, se tom√≥ la ciudad de Barcelona para visualizar la relaci√≥n entre registros de lluvias y generaci√≥n hidroel√©ctrica por reservorio -dependiente de estos eventos clim√°ticos- y se cuentan con escasos valores de correlaci√≥n.
"""